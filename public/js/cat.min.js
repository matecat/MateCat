function htmlEncode(b){return b?a=jQuery("<div />").text(b).html():""}function htmlDecode(a){return a?$("<div />").html(a).text():""}function utf8_to_b64(a){return window.btoa(unescape(encodeURIComponent(a)))}function b64_to_utf8(a){return decodeURIComponent(escape(window.atob(a)))}function handlepaste(a,b){var c=a.innerHTML;return b&&b.clipboardData&&b.clipboardData.getData?(/text\/html/.test(b.clipboardData.types)?(txt=UI.tagSelection?UI.tagSelection:htmlEncode(b.clipboardData.getData("text/plain")),a.innerHTML=txt):/text\/plain/.test(b.clipboardData.types)?(txt=UI.tagSelection?UI.tagSelection:htmlEncode(b.clipboardData.getData("text/plain")),a.innerHTML=txt):a.innerHTML="",waitforpastedata(a,c),b.preventDefault&&(b.stopPropagation(),b.preventDefault()),!1):(a.innerHTML="",waitforpastedata(a,c),!0)}function waitforpastedata(a,b){a.childNodes&&a.childNodes.length>0?processpaste(a,b):(that={e:a,s:b},that.callself=function(){waitforpastedata(that.e,that.s)},setTimeout(that.callself,20))}function processpaste(a,b){pasteddata=a.innerHTML,a.innerHTML=b,$("#placeHolder").before(pasteddata),focusOnPlaceholder(),$("#placeHolder").remove()}function focusOnPlaceholder(){var a=document.getElementById("placeHolder");if(a){var b,c;window.getSelection&&document.createRange?(c=document.createRange(),c.selectNodeContents(a),c.collapse(!0),b=window.getSelection(),b.removeAllRanges(),b.addRange(c)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(a),c.select())}}function truncate_filename(a,b){var c=a.substring(a.lastIndexOf(".")+1,a.length).toLowerCase(),d=a.replace("."+c,"");return d.length<=b?a:(d=d.substr(0,b)+(a.length>b?"[...]":""),d+"."+c)}function insertNodeAtCursor(a){var b,c;window.getSelection&&window.getSelection().getRangeAt?"Caret"==window.getSelection().type&&(b=window.getSelection().getRangeAt(0),b.insertNode(a)):document.selection&&document.selection.createRange&&(b=document.selection.createRange(),c=3==a.nodeType?a.data:a.outerHTML,b.pasteHTML(c))}function pasteHtmlAtCaret(a,b){var c,d;if(window.getSelection){if(c=window.getSelection(),c.getRangeAt&&c.rangeCount){d=c.getRangeAt(0),d.deleteContents();var e=document.createElement("div");e.innerHTML=a;for(var f,g,h=document.createDocumentFragment();f=e.firstChild;)g=h.appendChild(f);var i=h.firstChild;d.insertNode(h),g&&(d=d.cloneRange(),d.setStartAfter(g),b?d.setStartBefore(i):d.collapse(!0),c.removeAllRanges(),c.addRange(d))}}else if((c=document.selection)&&"Control"!=c.type){var j=c.createRange();j.collapse(!0),c.createRange().pasteHTML(a),b&&(d=c.createRange(),d.setEndPoint("StartToStart",j),d.select())}}function setCursorPosition(a,b){b=b||0;var c=document.createRange(),d=window.getSelection();c.setStart(a,b),"end"==b&&c.setStartAfter(a),c.collapse(!0),d.removeAllRanges(),d.addRange(c),a.focus()}function removeSelectedText(){if(window.getSelection||document.getSelection){var a=(window.getSelection?window:document).getSelection();if("Caret"==a.type)a.extentOffset!=a.baseOffset&&a.deleteFromDocument();else if("Range"==a.type){var b=$(a.baseNode).parent()[0];$(b).hasClass("selected")?$(b).remove():a.deleteFromDocument()}}else document.selection.clear()}function placehold_xliff_tags(a){return a=a.replace(/<(g\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER),a=a.replace(/<(\/g)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER),a=a.replace(/<(x.*?\/?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER),a=a.replace(/<(bx.*?\/?])>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(ex.*?\/?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(bpt\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/bpt)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(ept\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/ept)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(ph\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/ph)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(it\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/ph)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(it\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/it)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(mrk\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/mrk)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a)}function restore_xliff_tags(a){return a=a.replace(re_lt,"<"),a=a.replace(re_gt,">")}function restore_xliff_tags_for_view(a){return a=a.replace(re_lt,"&lt;"),a=a.replace(re_gt,"&gt;")}function view2rawxliff(a){return a=placehold_xliff_tags(a),a=htmlEncode(a),a=restore_xliff_tags(a)}function rawxliff2view(a){return a=placehold_xliff_tags(a),a=htmlDecode(a),a=a.replace(/<(.*?)>/i,"&lt;$1&gt;"),a=restore_xliff_tags_for_view(a)}function rawxliff2rawview(a){return a=placehold_xliff_tags(a),a=htmlDecode(a),a=restore_xliff_tags_for_view(a)}function saveSelection(a){var b="undefined"==typeof b?UI.editarea:a;UI.savedSel&&rangy.removeMarkers(UI.savedSel),UI.savedSel=rangy.saveSelection(),b.html(b.html().replace(UI.cursorPlaceholder,"")),UI.savedSelActiveElement=document.activeElement}function restoreSelection(){UI.savedSel&&(rangy.restoreSelection(UI.savedSel,!0),UI.savedSel=null,window.setTimeout(function(){UI.savedSelActiveElement&&"undefined"!=typeof UI.savedSelActiveElement.focus&&UI.savedSelActiveElement.focus()},1))}function selectText(a){var b,c,d=document,e=a;d.body.createTextRange?(b=document.body.createTextRange(),b.moveToElementText(e),b.select()):window.getSelection&&(c=window.getSelection(),b=document.createRange(),b.selectNodeContents(e),c.removeAllRanges(),c.addRange(b))}function getSelectionHtml(){var a="";if("undefined"!=typeof window.getSelection){var b=window.getSelection();if(b.rangeCount){for(var c=document.createElement("div"),d=0,e=b.rangeCount;e>d;++d)c.appendChild(b.getRangeAt(d).cloneContents());a=c.innerHTML}}else"undefined"!=typeof document.selection&&"Text"==document.selection.type&&(a=document.selection.createRange().htmlText);return a}function setBrowserHistoryBehavior(){window.onpopstate=function(){segmentId=location.hash.substr(1),UI.segmentIsLoaded(segmentId)?$(".editarea",$("#segment-"+segmentId)).click():$("section").length&&UI.pointBackToSegment(segmentId)}}UI=null,UI={toggleFileMenu:function(){if($("#jobMenu").is(":animated"))return!1;this.body.hasClass("editing")?$("#jobMenu .currSegment").show():$("#jobMenu .currSegment").hide();var a=$("#jobMenu").height();$("#jobMenu").css("top",47-a+"px"),$("#jobMenu").hasClass("open")?$("#jobMenu").animate({top:"-="+a+"px"},500).removeClass("open"):$("#jobMenu").animate({top:"+="+a+"px"},300,function(){$("body").on("click",function(){$("#jobMenu").hasClass("open")&&UI.toggleFileMenu()})}).addClass("open")},activateSegment:function(){this.createFooter(this.currentSegment),this.createButtons(),this.createHeader()},cacheObjects:function(a){this.editarea=$(a),this.lastOpenedSegment=this.currentSegment,this.lastOpenedEditarea=$(".editarea",this.currentSegment),this.currentSegmentId=this.lastOpenedSegmentId=this.editarea.data("sid"),this.currentSegment=segment=$("#segment-"+this.currentSegmentId),this.currentFile=segment.parent(),this.currentFileId=this.currentFile.attr("id").split("-")[1];var b=$(".source",this.currentSegment).html().match(/(&lt;\s*\/*\s*(g|x|bx|ex|bpt|ept|ph|it|mrk)\s*.*?&gt;)/gi);this.sourceTags=b||[]},changeStatus:function(a,b,c){var d=c?$(a).parents("section"):$("#"+$(a).data("segmentid"));$(".percentuage",d).removeClass("visible"),d.hasClass("saved")||this.setTranslation(d,b),d.removeClass("saved"),this.setContribution(d,b,c),this.setContributionMT(d,b,c),this.getNextSegment(this.currentSegment,"untranslated"),$(window).trigger({type:"statusChanged",segment:d,status:b})},checkHeaviness:function(){$("section").length>500&&UI.reloadToSegment(UI.nextUntranslatedSegmentId)},checkIfFinished:function(a){this.progress_perc!=this.done_percentage&&"100"==this.progress_perc||a&&"100"==this.progress_perc?this.body.addClass("justdone"):this.body.removeClass("justdone")},checkIfFinishedFirst:function(){$("section").length==$("section.status-translated, section.status-approved").length&&this.body.addClass("justdone")},checkTutorialNeed:function(){return Loader.detect("tutorial")?void($.cookie("noTutorial")||($("#dialog").dialog({}),$("#hideTutorial").bind("change",function(){$("#hideTutorial").attr("checked")?$.cookie("noTutorial",!0):$.removeCookie("noTutorial")}))):!1},closeSegment:function(a,b,c){if("undefined"==typeof a||"undefined"!=typeof UI.toSegment)return this.toSegment=void 0,!0;new Date;this.autoSave=!1,$(window).trigger({type:"segmentClosed",segment:a}),clearTimeout(this.liveConcordanceSearchReq);var d=!0;"noSave"!=c&&("translated"==c||"Save"==c)&&(d=!1),a.hasClass("modified")&&d&&this.saveSegment(a),this.deActivateSegment(b),this.lastOpenedEditarea.attr("contenteditable","false"),this.body.removeClass("editing"),$(a).removeClass("editor"),$("span.locked.mismatch",a).removeClass("mismatch"),this.opening||this.checkIfFinished(1)},copySource:function(){var a=$.trim($(".source",this.currentSegment).text());this.saveInUndoStack("copysource"),$(".editarea",this.currentSegment).text(a).keyup().focus(),this.saveInUndoStack("copysource"),$(".editarea",this.currentSegment).effect("highlight",{},1e3),$(window).trigger({type:"sourceCopied",segment:segment}),this.currentSegment.addClass("modified"),this.currentSegmentQA(),this.setChosenSuggestion(0),this.lockTags(this.editarea)},confirmDownload:function(a){a&&UI.isChrome&&($(".download-chrome").addClass("d-open"),setTimeout(function(){$(".download-chrome").removeClass("d-open")},7e3))},copyToNextIfSame:function(a){$(".source",this.currentSegment).data("original")==$(".source",a).data("original")&&$(".editarea",a).hasClass("fromSuggestion")&&$(".editarea",a).text(this.editarea.text())},createButtons:function(){var a=this.currentSegment.hasClass("loaded")?"":' disabled="disabled"',b='<li><a id="segment-'+this.currentSegmentId+'-nextuntranslated" href="#" class="btn next-untranslated" data-segmentid="segment-'+this.currentSegmentId+'" title="Translate and go to next untranslated">T+&gt;&gt;</a><p>'+(UI.isMac?"CMD":"CTRL")+'+SHIFT+ENTER</p></li><li><a id="segment-'+this.currentSegmentId+'-button-translated" data-segmentid="segment-'+this.currentSegmentId+'" href="#" class="translated"'+a+" >TRANSLATED</a><p>"+(UI.isMac?"CMD":"CTRL")+"+ENTER</p></li>";$("#segment-"+this.currentSegmentId+"-buttons").empty().append(b),$("#segment-"+this.currentSegmentId+"-buttons").before('<p class="warnings"></p>')},createFooter:function(a){if(""!==$(".matches .overflow",a).text())return!1;if(""!==$(".footer",a).text())return!1;var b='<ul class="submenu"><li class="active tab-switcher-tm" id="segment-'+this.currentSegmentId+'-tm"><a tabindex="-1" href="#">Translation matches</a></li><li class="tab-switcher-cc" id="segment-'+this.currentSegmentId+'-cc"><a tabindex="-1" href="#">Concordance</a></li><li class="tab-switcher-gl" id="segment-'+this.currentSegmentId+'-gl"><a tabindex="-1" href="#">Glossary&nbsp;<span class="number"></span></a></li></ul><div class="tab sub-editor matches" id="segment-'+this.currentSegmentId+'-matches"><div class="overflow"></div></div><div class="tab sub-editor concordances" id="segment-'+this.currentSegmentId+'-concordances"><div class="overflow"><div class="cc-search"><div class="input search-source" contenteditable="true" /><div class="input search-target" contenteditable="true" /></div><div class="results"></div></div></div><div class="tab sub-editor glossary" id="segment-'+this.currentSegmentId+'-glossary"><div class="overflow"><div class="gl-search"><div class="input search-source" contenteditable="true" /><div class="input search-target" contenteditable="true" /><!-- a class="search-glossary" href="#"></a --><a class="set-glossary disabled" href="#"></a><div class="comment"><a href="#">(+) Comment</a><div class="input gl-comment" contenteditable="true" /></div></div><div class="results"></div></div></div>';$(".footer",a).html(b),$(a).hasClass("loaded")&&a===this.currentSegment&&""===$(a).find(".matches .overflow").text()&&($(".sub-editor.matches .overflow .graysmall.message",a).remove(),$(".sub-editor.matches .overflow",a).append('<ul class="graysmall message"><li>Sorry, we can\'t help you this time. Check if the language pair is correct. If not, create the project again.</li></ul>'))},createHeader:function(){if(!$("h2.percentuage",this.currentSegment).length){var a='<h2 title="" class="percentuage"><span></span></h2><a href="#" id="segment-'+this.currentSegmentId+'-close" class="close" title="Close this segment"></a><a href="/referenceFile/'+config.job_id+"/"+config.password+"/"+this.currentSegmentId+'" id="segment-'+this.currentSegmentId+'-context" class="context" title="Open context" target="_blank">Context</a>';$("#"+this.currentSegment.attr("id")+"-header").html(a)}},createJobMenu:function(){var a='<nav id="jobMenu" class="topMenu">    <ul>';$.each(config.firstSegmentOfFiles,function(){a+='<li data-file="'+this.id_file+'" data-segment="'+this.first_segment+'"><span class="'+UI.getIconClass(this.file_name.split(".")[this.file_name.split(".").length-1])+'"></span><a href="#" title="'+this.file_name+'" >'+this.file_name+"</a></li>"}),a+='    </ul>	<ul>		<li class="currSegment" data-segment="'+UI.currentSegmentId+'"><a href="#">Go to current segment</a></li>    </ul></nav>',this.body.append(a)},getIconClass:function(a){return c="doc"==a||"dot"==a||"docx"==a||"dotx"==a||"docm"==a||"dotm"==a||"odt"==a||"sxw"==a?"extdoc":"pot"==a||"pps"==a||"ppt"==a||"potm"==a||"potx"==a||"ppsm"==a||"ppsx"==a||"pptm"==a||"pptx"==a||"odp"==a||"sxi"==a?"extppt":"htm"==a||"html"==a?"exthtm":"pdf"==a?"extpdf":"xls"==a||"xlt"==a||"xlsm"==a||"xlsx"==a||"xltx"==a||"ods"==a||"sxc"==a||"csv"==a?"extxls":"txt"==a?"exttxt":"ttx"==a?"extttx":"itd"==a?"extitd":"xlf"==a?"extxlf":"mif"==a?"extmif":"idml"==a?"extidd":"xtg"==a?"extqxp":"xml"==a?"extxml":"rc"==a?"extrcc":"resx"==a?"extres":"sgml"==a?"extsgl":"sgm"==a?"extsgm":"properties"==a?"extpro":"extxif"},createStatusMenu:function(a){$("ul.statusmenu").empty().hide();var b='<li class="arrow"><span class="arrow-mcolor"></span></li><li><a href="#" class="f" data-sid="segment-'+this.currentSegmentId+'" title="set draft as status">DRAFT</a></li><li><a href="#" class="d" data-sid="segment-'+this.currentSegmentId+'" title="set translated as status">TRANSLATED</a></li><li><a href="#" class="a" data-sid="segment-'+this.currentSegmentId+'" title="set approved as status">APPROVED</a></li><li><a href="#" class="r" data-sid="segment-'+this.currentSegmentId+'" title="set rejected as status">REJECTED</a></li>';a.html(b).show()},deActivateSegment:function(a){this.removeButtons(a),this.removeHeader(a),this.removeFooter(a)},detectAdjacentSegment:function(a,b,c){if(c||(c=1),"down"==b?(adjacent=a.next(),adjacent.is("section")||(adjacent=this.currentFile.next().find("section:first"))):(adjacent=a.prev(),adjacent.is("section")||(adjacent=$(".editor").parents("article").prev().find("section:last"))),adjacent.length){if(1==c)return adjacent;this.detectAdjacentSegment(adjacent,b,c-1)}},detectFirstLast:function(){var a=$("section");this.firstSegment=a.first(),this.lastSegment=a.last()},setSegmentPointer:function(){$(".editor").length&&($(".editor").isOnScreen()?$("#segmentPointer").hide():$(window).scrollTop()>$(".editor").offset().top?$("#segmentPointer").removeClass("down").css("margin-top","-10px").addClass("up").show():$("#segmentPointer").removeClass("up").addClass("down").css("margin-top",$(window).height()-140+"px").show())},detectRefSegId:function(a){var b=(this.moreSegNum,"after"==a?$("section").last():"before"==a?$("section").first():""),c=b.length?b.attr("id").split("-")[1]:0;return c},detectStartSegment:function(){if(this.segmentToScrollAtRender)this.startSegmentId=this.segmentToScrollAtRender;else{var a=window.location.hash.substr(1);this.startSegmentId=a?a:config.last_opened_segment}},nextUnloadedResultSegment:function(){var a="",b=$("section").last().attr("id").split("-")[1];return $.each(this.searchResultsSegments,function(){return!$("#segment-"+this).length&&parseInt(this)>parseInt(b)?(a=parseInt(this),!1):void 0}),""===a&&(a=this.searchResultsSegments[0]),a},footerMessage:function(a,b){$(".footer-message",b).remove(),$(".submenu",b).append('<li class="footer-message">'+a+"</div>"),$(".footer-message",b).fadeOut(6e3)},getMoreSegments:function(a){if(!("after"==a&&this.noMoreSegmentsAfter||"before"==a&&this.noMoreSegmentsBefore||this.loadingMore)){this.loadingMore=!0;var b=this.detectRefSegId(a);"before"==a&&$("section").each(function(){return $(this).offset().top>$(window).scrollTop()?(UI.segMoving=$(this).attr("id").split("-")[1],!1):void 0}),"before"==a?$("#outer").addClass("loadingBefore"):"after"==a&&$("#outer").addClass("loading"),APP.doRequest({data:{action:"getSegments",jid:config.job_id,password:config.password,step:50,segment:b,where:a},success:function(a){UI.getMoreSegments_success(a)}})}},getMoreSegments_success:function(a){if(a.error.length&&this.processErrors(a.error,"getMoreSegments"),where=a.data.where,"undefined"!=typeof a.data.files){firstSeg=$("section").first(),lastSeg=$("section").last();var b=0;$.each(a.data.files,function(){b+=this.segments.length}),this.renderSegments(a.data.files,where,!1),"before"==where&&b&&this.scrollSegment($("#segment-"+this.segMoving)),this.body.hasClass("searchActive")?(segLimit="before"==where?firstSeg:lastSeg,this.markSearchResults({where:where,seg:segLimit})):this.markTags()}0===a.data.files.length&&("after"==where&&(this.noMoreSegmentsAfter=!0),"before"==where&&(this.noMoreSegmentsBefore=!0)),$("#outer").removeClass("loading loadingBefore"),this.loadingMore=!1,this.setWaypoints()},getNextSegment:function(a,b){var c=this.currentSegment,d="untranslated"==b?"section.status-draft:not(.readonly), section.status-rejected:not(.readonly), section.status-new:not(.readonly)":"section.status-"+b+":not(.readonly)",e=$(c).nextAll(d).first();e.length||(e=$(c).parents("article").next().find(d).first()),this.nextUntranslatedSegmentId=e.length?$(e).attr("id").split("-")[1]:UI.nextUntranslatedSegmentIdByServer&&!UI.noMoreSegmentsAfter?UI.nextUntranslatedSegmentIdByServer:0;var f=$(c).next();f.length||(f=$(c).parents("article").next().find("section").first()),this.nextSegmentId=f.length?$(f).attr("id").split("-")[1]:0},getPercentuageClass:function(a){var b="";switch(m_parse=parseInt(a),isNaN(m_parse)||(a=m_parse),!0){case 100==a:b="per-green";break;case 101==a:b="per-blue";break;case a>0&&99>=a:b="per-orange";break;case"MT"==a:b="per-yellow";break;default:b=""}return b},getSegments:function(a){where=this.startSegmentId?"center":"after";var b=this.initSegNum;$("#outer").addClass("loading");var c=a.segmentToScroll?a.segmentToScroll:this.startSegmentId;APP.doRequest({data:{action:"getSegments",jid:config.job_id,password:config.password,step:b,segment:c,where:where},success:function(b){UI.getSegments_success(b,a)}})},getSegments_success:function(a,b){a.error.length&&this.processErrors(a.error,"getSegments"),where=a.data.where,$.each(a.data.files,function(){startSegmentId=this.segments[0].sid}),"undefined"==typeof this.startSegmentId&&(this.startSegmentId=startSegmentId),this.body.addClass("loaded"),"undefined"!=typeof a.data.files&&(this.renderSegments(a.data.files,where,this.firstLoad),!b.openCurrentSegmentAfter||b.segmentToScroll||b.segmentToOpen||(seg=UI.firstLoad?this.currentSegmentId:UI.startSegmentId,this.gotoSegment(seg)),b.segmentToScroll&&this.scrollSegment($("#segment-"+b.segmentToScroll)),b.segmentToOpen&&$("#segment-"+b.segmentToOpen+" .editarea").click(),$("#segment-"+UI.currentSegmentId).length&&!$("section.editor").length&&UI.openSegment(UI.editarea),"link2file"==b.caller&&UI.segmentIsLoaded(UI.currentSegmentId)&&UI.openSegment(UI.editarea),$("#segment-"+UI.startSegmentId).hasClass("readonly")&&this.scrollSegment($("#segment-"+UI.startSegmentId)),b.applySearch&&($("mark.currSearchItem").removeClass("currSearchItem"),this.markSearchResults(),"normal"==this.searchMode?$("#segment-"+b.segmentToScroll+" mark.searchMarker").first().addClass("currSearchItem"):$("#segment-"+b.segmentToScroll+" .editarea mark.searchMarker").first().addClass("currSearchItem"))),$("#outer").removeClass("loading loadingBefore"),this.loadingMore=!1,this.setWaypoints(),this.markTags()},getSegmentSource:function(a){return segment="undefined"==typeof a?this.currentSegment:a,$(".source",segment).text()},getStatus:function(a){return status=$(a).hasClass("status-new")?"new":$(a).hasClass("status-draft")?"draft":$(a).hasClass("status-translated")?"translated":$(a).hasClass("status-approved")?"approved":"rejected"},getSegmentTarget:function(a){return editarea="undefined"==typeof a?this.editarea:$(".editarea",a),editarea.text()},getUpdates:function(){UI.chunkedSegmentsLoaded()&&(lastUpdateRequested=UI.lastUpdateRequested,UI.lastUpdateRequested=new Date,APP.doRequest({data:{action:"getUpdatedTranslations",last_timestamp:lastUpdateRequested.getTime(),first_segment:$("section").first().attr("id").split("-")[1],last_segment:$("section").last().attr("id").split("-")[1]},success:function(a){UI.lastUpdateRequested=new Date,UI.updateSegments(a.data)}})),setTimeout(function(){UI.getUpdates()},UI.checkUpdatesEvery)},updateSegments:function(a){$.each(a,function(){seg=$("#segment-"+this.sid),$(".editarea, .area",seg).text(this.translation),status="DRAFT"==this.status?"draft":"TRANSLATED"==this.status?"translated":"APPROVED"==this.status?"approved":"REJECTED"==this.status?"rejected":"",UI.setStatus(seg,status)})},test:function(a){console.log("params: ",a),console.log("giusto")},gotoNextSegment:function(){var a=$(".editor").next();a.is("section")?(this.scrollSegment(a),$(".editarea",a).trigger("click","moving")):(a=this.currentFile.next().find("section:first"),a.length&&(this.scrollSegment(a),$(".editarea",a).trigger("click","moving")))},gotoOpenSegment:function(){$("#segment-"+this.currentSegmentId).length?this.scrollSegment(this.currentSegment):($("#outer").empty(),this.render({firstLoad:!1,segmentToOpen:this.currentSegmentId})),$(window).trigger({type:"scrolledToOpenSegment",segment:segment})},gotoPreviousSegment:function(){var a=$(".editor").prev();a.is("section")?$(".editarea",a).click():(a=$(".editor").parents("article").prev().find("section:last"),a.length?$(".editarea",a).click():this.topReached()),a.length&&this.scrollSegment(a)},gotoSegment:function(a){var b=$("#segment-"+a+"-target").find(".editarea");$(b).click()},initSegmentNavBar:function(){1==config.firstSegmentOfFiles.length&&$("#segmentNavBar .prevfile, #segmentNavBar .nextfile").addClass("disabled")},justSelecting:function(a){if(window.getSelection().isCollapsed)return!1;var b=$(window.getSelection().getRangeAt(0).startContainer.parentNode);return console.log(b),"editarea"==a?b.hasClass("editarea")&&!b.is(UI.editarea):"readonly"==a?b.hasClass("area")||b.hasClass("source"):void 0},closeInplaceEditor:function(a){$(a).removeClass("editing"),$(a).attr("contenteditable",!1),$(".graysmall .edit-buttons").remove()},openInplaceEditor:function(a){$(".graysmall .translation.editing").each(function(){UI.closeInplaceEditor($(this))}),$(a).addClass("editing").attr("contenteditable",!0).after('<span class="edit-buttons"><button class="cancel">Cancel</button><button class="save">Save</button></span>'),$(a).focus()},millisecondsToTime:function(a){var b=Math.round(a/1e3%60),c=Math.floor(a/6e4%60);return[c,b]},closeContextMenu:function(){$("#contextMenu").hide(),$("#spellCheck .words").remove()},openSegment:function(a,b){var c=$("#segment-"+$(a).attr("data-sid"));if(this.openSegmentStart=new Date,this.byButton||!this.justSelecting("editarea")){if(this.firstOpenedSegment=0===this.firstOpenedSegment?1:2,this.byButton=!1,this.cacheObjects(a),this.updateJobMenu(),$(window).trigger({type:"segmentOpened",segment:c}),this.clearUndoStack(),this.saveInUndoStack("open"),this.autoSave=!0,this.activateSegment(),this.getNextSegment(this.currentSegment,"untranslated"),this.setCurrentSegment(c),this.currentSegment.addClass("opened"),this.currentSegment.attr("data-searchItems",$("mark.searchMarker",this.editarea).length),this.fillCurrentSegmentWarnings(this.globalWarnings,!0),this.setNextWarnedSegment(),this.focusEditarea=setTimeout(function(){UI.editarea.focus(),clearTimeout(UI.focusEditarea)},100),this.currentIsLoaded=!1,this.nextIsLoaded=!1,this.readonly||this.getContribution(c,0),this.noGlossary||this.getGlossary(c,!0,0),this.opening=!0,!this.currentSegment.is(this.lastOpenedSegment)){var d=$(this.lastOpenedSegment).attr("id");d!="segment-"+this.currentSegmentId&&this.closeSegment(this.lastOpenedSegment,0,b)}this.opening=!1,this.body.addClass("editing"),c.addClass("editor"),this.readonly||this.editarea.attr("contenteditable","true"),this.editStart=new Date,$(a).removeClass("indent"),this.lockTags(),this.readonly||(this.getContribution(c,1),this.getContribution(c,2),this.noGlossary||this.getGlossary(c,!0,1),this.noGlossary||this.getGlossary(c,!0,2)),this.debug&&console.log("close/open time: "+(new Date-this.openSegmentStart))}},placeCaretAtEnd:function(a){if($(a).focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();b.selectNodeContents(a),b.collapse(!1);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}},registerQACheck:function(){clearTimeout(UI.pendingQACheck),UI.pendingQACheck=setTimeout(function(){UI.currentSegmentQA()},config.segmentQACheckInterval)},reloadToSegment:function(a){this.infiniteScroll=!1,config.last_opened_segment=a,window.location.hash=a,$("#outer").empty(),this.render({firstLoad:!1})},renderUntranslatedOutOfView:function(){this.infiniteScroll=!1,config.last_opened_segment=this.nextUntranslatedSegmentId,window.location.hash=this.nextUntranslatedSegmentId,$("#outer").empty(),this.render({firstLoad:!1})},reloadWarning:function(){this.renderUntranslatedOutOfView()},pointBackToSegment:function(a){this.infiniteScroll&&(""===a?(this.startSegmentId=config.last_opened_segment,$("#outer").empty(),this.render({firstLoad:!1})):($("#outer").empty(),this.render({firstLoad:!1})))},pointToOpenSegment:function(){this.gotoOpenSegment()},removeButtons:function(a){var b=a?this.currentSegment:this.lastOpenedSegment;$("#"+b.attr("id")+"-buttons").empty(),$("p.warnings",b).remove()},removeFooter:function(){},removeHeader:function(a){var b=a?this.currentSegment:this.lastOpenedSegment;$("#"+b.attr("id")+"-header").empty()},removeStatusMenu:function(a){a.empty().hide()},renderSegments:function(a,b,c){$.each(a,function(a){var c="",d=this.file_stats,e=a,f="center"!=b&&$("#file-"+e).length?!1:!0;f&&(filenametoshow=truncate_filename(this.filename,40),c+='<article id="file-'+e+'" class="loading">	<ul class="projectbar" data-job="job-'+this.jid+'">		<li class="filename">			<form class="download" action="/" method="post">				<input type=hidden name="action" value="downloadFile">				<input type=hidden name="id_job" value="'+this.jid+'">				<input type=hidden name="id_file" value="'+e+'">				<input type=hidden name="filename" value="'+this.filename+'">				<input type=hidden name="password" value="'+config.password+'">				<!--input title="Download file" type="submit" value="" class="downloadfile" id="file-'+e+'-download" -->			</form>			<h2 title="'+this.filename+'">'+filenametoshow+'</div>		</li>		<li style="text-align:center;text-indent:-20px">			<strong>'+this.source+'</strong> [<span class="source-lang">'+this.source_code+"</span>]&nbsp;>&nbsp;<strong>"+this.target+'</strong> [<span class="target-lang">'+this.target_code+'</span>]		</li>		<li class="wordcounter">			Payable Words: <strong>'+d.TOTAL_FORMATTED+'</strong>			<span id="rejected" class="hidden">Rejected: <strong>'+d.REJECTED_FORMATTED+"</strong></span>		</li>	</ul>");var g=config.time_to_edit_enabled;$.each(this.segments,function(){var a="true"==this.readonly?!0:!1,b=htmlEncode(this.segment.replace(/\"/g,"&quot;"));b=b.replace(config.lfPlaceholderRegex,"\n"),b=b.replace(config.crPlaceholderRegex,"\r"),b=b.replace(config.crlfPlaceholderRegex,"\r\n"),c+='<section id="segment-'+this.sid+'" class="'+(a?"readonly ":"")+"status-"+(this.status?this.status.toLowerCase():"new")+("true"==this.has_reference?" has-reference":"")+'">	<a tabindex="-1" href="#'+this.sid+'"></a>	<span class="sid">'+this.sid+'</span>	<div class="body">		<div class="header toggle" id="segment-'+this.sid+'-header">		</div>		<div class="text">			<div class="wrap">				<div class="outersource"><div class="source item" tabindex="0" id="segment-'+this.sid+'-source" data-original="'+b+'">'+UI.decodePlaceholdersToText(this.segment)+'</div>				<div class="copy" title="Copy source to target">                   <a href="#"></a>                   <p>'+(UI.isMac?"CMD":"CTRL")+'+RIGHT</p>				</div>				<div class="target item" id="segment-'+this.sid+'-target">					<span class="hide toggle"> 						<a href="#" class="warning normalTip exampleTip" title="Warning: as">!</a>					</span>					<div class="textarea-container">						<span class="loader"></span>						<div class="'+(a?"area":"editarea")+' invisible" '+(a?"":'contenteditable="false" ')+'spellcheck="true" lang="'+config.target_lang.toLowerCase()+'" id="segment-'+this.sid+'-editarea" data-sid="'+this.sid+'">'+(this.translation?UI.decodePlaceholdersToText(this.translation):"")+'</div>						<p class="save-warning" title="Segment modified but not saved"></p>					</div> <!-- .textarea-container -->				</div> <!-- .target -->			</div></div> <!-- .wrap -->						<ul class="buttons toggle" id="segment-'+this.sid+'-buttons"></ul>			<div class="status-container">				<a href=# title="'+(this.status?this.status.toLowerCase()+", click to change it":"Change segment status")+'" class="status" id="segment-'+this.sid+'-changestatus"></a>			</div> <!-- .status-container -->		</div> <!-- .text -->		<div class="timetoedit" data-raw_time_to_edit="'+this.time_to_edit+'">'+(g?"			<span class=edit-min>"+this.parsed_time_to_edit[1]+"</span>m:":"")+(g?"			<span class=edit-sec>"+this.parsed_time_to_edit[2]+"</span>s":"")+'		</div>		<div class="footer toggle"></div> <!-- .footer -->     	</div> <!-- .body -->	<ul class="statusmenu"></ul></section> '}),f&&(c+="</article>"),f?"before"==b?("undefined"!=typeof lastArticleAdded?$("#file-"+e).after(c):$("article").first().before(c),lastArticleAdded=e):"after"==b?$("article").last().after(c):"center"==b&&$("#outer").append(c):"before"==b?$("#file-"+e).prepend(c):"after"==b&&$("#file-"+e).append(c)}),c&&this.init()},saveSegment:function(a){var b=a.hasClass("status-translated")?"translated":a.hasClass("status-approved")?"approved":a.hasClass("status-rejected")?"rejected":a.hasClass("status-new")?"new":"draft";"new"==b&&(b="draft"),console.log("SAVE SEGMENT"),this.setTranslation(a,b,"autosave"),a.addClass("saved")},renderAndScrollToSegment:function(a){$("#outer").empty(),this.render({firstLoad:!1,caller:"link2file",segmentToScroll:a,scrollToFile:!0})},scrollSegment:function(a){a.length||($("#outer").empty(),this.render({firstLoad:!1,segmentToOpen:a.selector.split("-")[1]}));var b=23,c=this.currentSegment,d=$(a).prev("section");d.length||(d=$(a),b=103);var e="#"+d.attr("id"),f=$(e).offset().top;if(this.firstScroll&&(f+=100,this.firstScroll=!1),$(c).length)if($(a).offset().top>$(c).offset().top)if(c.is($(a).prev()))f-=b;else{var g=this.firstLoad?$(c).height()-200+120:20;f-=g}else f-=b;else f-=b;$("html,body").stop(),$("html,body").animate({scrollTop:f-20},500),setTimeout(function(){UI.goingToNext=!1},500)},segmentIsLoaded:function(a){return $("#segment-"+a).length?!0:!1},spellCheck:function(a){return UI.customSpellcheck?(editarea="undefined"==typeof a?UI.editarea:$(a),"block"==$("#contextMenu").css("display")?!0:void APP.doRequest({data:{action:"getSpellcheck",lang:config.target_rfc,sentence:UI.editarea.text()},context:editarea,success:function(b){a=this,$.each(b.result,function(b,c){var d=Object.keys(c)[0];
replacements=c[d].misses.join(",");var e=[parseInt(c[d].offset),parseInt(c[d].offset)+parseInt(d.length)],f=(a.text().substring(e[0],e[1]),new RegExp("(\\b"+d+"\\b)","gi"));$(a).html($(a).html().replace(f,'<span class="misspelled" data-replacements="'+replacements+'">$1</span>')),$(a).html($(a).html().replace(/(<span class=\"misspelled\" data-replacements=\"(.*?)\"\>)(<span class=\"misspelled\" data-replacements=\"(.*?)\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"))})}})):!1},addWord:function(a){APP.doRequest({data:{action:"setSpellcheck",slang:config.target_rfc,word:a},success:function(){}})},setCurrentSegment:function(a,b){var c=this.currentSegmentId;b?(c=0,UI.currentSegment=void 0):setTimeout(function(){window.location.hash;window.location.hash=UI.currentSegmentId},300);this.currentFile;this.readonly||APP.doRequest({data:{action:"setCurrentSegment",password:config.password,id_segment:c,id_job:config.job_id},success:function(a){UI.setCurrentSegment_success(a)}})},setCurrentSegment_success:function(a){a.error.length&&this.processErrors(a.error,"setCurrentSegment"),this.nextUntranslatedSegmentIdByServer=a.nextSegmentId,this.getNextSegment(this.currentSegment,"untranslated")},setDownloadStatus:function(a){var b="approved";parseFloat(a.TRANSLATED)&&(b="translated"),parseFloat(a.DRAFT)&&(b="draft"),parseFloat(a.REJECTED)&&(b="draft"),$(".downloadtr-button").removeClass("draft translated approved").addClass(b);var c="translated"==b?"DOWNLOAD TRANSLATION":"PREVIEW";$("#downloadProject").attr("value",c)},setProgress:function(a){var b=a;m=$("footer .meter");var c=(b.TOTAL,b.TRANSLATED_PERC),d=b.APPROVED_PERC,e=b.DRAFT_PERC,f=b.REJECTED_PERC,g=b.TRANSLATED_PERC_FORMATTED,h=b.APPROVED_PERC_FORMATTED,i=b.DRAFT_PERC_FORMATTED,j=b.REJECTED_PERC_FORMATTED,k=(b.DRAFT_FORMATTED,b.REJECTED_FORMATTED,b.TODO_FORMATTED),l=b.WORDS_PER_HOUR,n=b.ESTIMATED_COMPLETION;"undefined"==typeof l?$("#stat-wph").hide():$("#stat-wph").show(),"undefined"==typeof n?$("#stat-completion").hide():$("#stat-completion").show(),this.progress_perc=b.PROGRESS_PERC_FORMATTED,this.checkIfFinished(),this.done_percentage=this.progress_perc,$(".approved-bar",m).css("width",d+"%").attr("title","Approved "+h+"%"),$(".translated-bar",m).css("width",c+"%").attr("title","Translated "+g+"%"),$(".draft-bar",m).css("width",e+"%").attr("title","Draft "+i+"%"),$(".rejected-bar",m).css("width",f+"%").attr("title","Rejected "+j+"%"),$("#stat-progress").html(this.progress_perc),$("#stat-todo strong").html(k),$("#stat-wph strong").html(l),$("#stat-completion strong").html(n)},chunkedSegmentsLoaded:function(){return $("section.readonly").length},setStatus:function(a,b){a.removeClass("status-draft status-translated status-approved status-rejected status-new").addClass("status-"+b)},setStatusButtons:function(a){isTranslatedButton=$(a).hasClass("translated")?!0:!1,this.editStop=new Date;var b=this.currentSegment;tte=$(".timetoedit",b),this.editTime=this.editStop-this.editStart,this.totalTime=this.editTime+tte.data("raw_time_to_edit");var c=this.millisecondsToTime(this.totalTime);if(config.time_to_edit_enabled){var d=$(".timetoedit .edit-sec",b),e=$(".timetoedit .edit-min",b);e.text(this.zerofill(c[0],2)),d.text(this.zerofill(c[1],2))}tte.data("raw_time_to_edit",this.totalTime);var f=$(".status",b);f.removeClass("col-approved col-rejected col-done col-draft");var g=$("#segment-"+this.nextUntranslatedSegmentId);return this.nextUntranslatedSegment=g,isTranslatedButton||g.length?(this.buttonClickStop=new Date,this.copyToNextIfSame(g),void(this.byButton=!0)):($(".editor:visible").find(".close").trigger("click","Save"),$(".downloadtr-button").focus(),!1)},collectSegmentErrors:function(a){var b="";return a.hasClass("mismatch")&&(b+="01|"),b.substring(0,b.length-1)},goToFirstError:function(){location.href=$("#point2seg").attr("href")},continueDownload:function(){$("form#fileDownload").unbind().submit().bind("submit",function(a){a.preventDefault()})},setNextWarnedSegment:function(a){a=a||UI.currentSegmentId,idList=UI.globalWarnings,$.each(idList,function(){return this>a?($("#point2seg").attr("href","#"+this),!1):void(this==idList[idList.length-1]&&$("#point2seg").attr("href","#"+idList[0]))})},fillWarnings:function(a,b){var c=a.find("p.warnings").parent(),d=a.find("p.warnings");$.each(b,function(a,b){c.before(d).append('<p class="warnings">'+b.debug+"</p>")}),d.remove()},fillCurrentSegmentWarnings:function(a,b){b||UI.fillWarnings(UI.currentSegment,$.parseJSON(a.warnings))},compareArrays:function(a,b){return $.each(a,function(c,d){t=d,$.each(b,function(d,e){return t==e?(a.splice(c,1),b.splice(d,1),UI.compareArrays(a,b),!1):void 0})}),a},checkWarnings:function(a){var b=new Date;ts=b.getTime();var c="undefined"==typeof this.currentSegmentId?this.startSegmentId:this.currentSegmentId,d=c+"-"+ts.toString();APP.doRequest({data:{action:"getWarning",id_job:config.job_id,password:config.password,token:d},success:function(b){var c="";UI.globalWarnings=b.details,UI.globalWarnings.length>0?(c="#"+b.details[Object.keys(b.details).sort().shift()].id_segment,a&&UI.fillCurrentSegmentWarnings(b.details,!0),$("#notifbox").attr("class","warningbox").attr("title","Some translations seems to have TAGS and/or other untraslatables that do not match the source").find(".numbererror").text(UI.globalWarnings.length)):($("#notifbox").attr("class","notific").attr("title","Well done, no errors found!").find(".numbererror").text(""),$("#point2seg").attr("href","#")),UI.setNextWarnedSegment()}})},currentSegmentQA:function(){this.currentSegment.addClass("waiting_for_check_result");var a=new Date;ts=a.getTime();var b=this.currentSegmentId+"-"+ts.toString();config.brPlaceholdEnabled?(src_content=this.postProcessEditarea(this.currentSegment,".source"),trg_content=this.postProcessEditarea(this.currentSegment)):(src_content=this.getSegmentSource(),trg_content=this.getSegmentTarget()),this.checkSegmentsArray[b]=trg_content,APP.doRequest({data:{action:"getWarning",id:this.currentSegmentId,token:b,password:config.password,src_content:src_content,trg_content:trg_content},success:function(a){if(UI.currentSegment.hasClass("waiting_for_check_result")){if(!a.total)return $("p.warnings",UI.currentSegment).empty(),void $("span.locked.mismatch",UI.currentSegment).removeClass("mismatch");if(UI.editarea.text().trim()!=UI.checkSegmentsArray[a.token].trim())return;UI.fillCurrentSegmentWarnings(a.details,!1),UI.markTagMismatch(a.details),delete UI.checkSegmentsArray[a.token],UI.currentSegment.removeClass("waiting_for_check_result")}}},"local")},setTranslation:function(a,b,c){c="undefined"==typeof c?!1:c;var d=$(a).attr("id").split("-"),e=d[1],f=$(a).parents("article");if(config.brPlaceholdEnabled?(console.log("s"),translation=this.postProcessEditarea(a)):translation=$(".editarea",a).text(),""===translation)return!1;var g=UI.editTime,h=config.id_translator,i="";i=this.collectSegmentErrors(a);var j=$(".editarea",a).data("lastChosenSuggestion");autosave="autosave"==c?!0:!1,APP.doRequest({data:{action:"setTranslation",id_segment:e,id_job:config.job_id,id_first_file:f.attr("id").split("-")[1],password:config.password,status:b,translation:translation,time_to_edit:g,id_translator:h,errors:i,chosen_suggestion_index:j,autosave:autosave},success:function(c){UI.setTranslation_success(c,a,b)}})},postProcessEditarea:function(a,b){b="undefined"==typeof b?".editarea":b,area=$(b,a).clone();var c=$(area).find("div");return c.length?c.each(function(){$(this).find("br:not([class])").remove(),$(this).prepend($('<span class="placeholder">'+config.crlfPlaceholder+"</span>")).replaceWith($(this).html())}):$(area).find("br:not([class])").replaceWith($('<span class="placeholder">'+config.crlfPlaceholder+"</span>")),area.text()},decodePlaceholdersToText:function(a){var b=a.replace(config.lfPlaceholderRegex,'<br class="'+config.lfPlaceholderClass+'" />').replace(config.crPlaceholderRegex,'<br class="'+config.crPlaceholderClass+'" />').replace(config.crlfPlaceholderRegex,'<br class="'+config.crlfPlaceholderClass+'" />');return b},processErrors:function(a,b){$.each(a,function(){"setTranslation"==b&&"-10"!=this.code&&APP.alert({msg:"Error in saving the translation. Try the following: <br />1) Refresh the page (Ctrl+F5 twice) <br />2) Clear the cache in the browser <br />If the solutions above does not resolve the issue, please stop the translation and report the problem to <b>support@matecat.com</b>"}),"setContribution"==b&&"-10"!=this.code&&APP.alert({msg:"Error in saving the translation memory.<br />Try the to save again the segment.<br />If the solutions above does not resolve the issue, please stop the translation and report the problem to <b>support@matecat.com</b>"}),"-10"==this.code&&APP.alert({msg:"Job canceled or assigned to another translator",callback:"reloadPage"})})},reloadPage:function(){console.log("reloadPage"),location.reload()},someSegmentToSave:function(){return res=$("section.modified").length?!0:!1},setContextMenu:function(){var a=this.isMac?"&#x2325;":"Alt ",b=this.isMac?"&#8984;":"Ctrl ";$("#contextMenu .shortcut .alt").html(a),$("#contextMenu .shortcut .cmd").html(b)},setTranslation_success:function(a,b,c){a.error.length&&this.processErrors(a.error,"setTranslation"),"OK"==a.data&&(this.setStatus(b,c),this.setDownloadStatus(a.stats),this.setProgress(a.stats),this.checkWarnings(!1))},setWaypoints:function(){this.firstSegment.waypoint("remove"),this.lastSegment.waypoint("remove"),this.detectFirstLast(),this.lastSegment.waypoint(function(a,b){"down"===b&&(UI.lastSegment.waypoint("remove"),UI.infiniteScroll&&(UI.blockGetMoreSegments||(UI.blockGetMoreSegments=!0,UI.getMoreSegments("after"),setTimeout(function(){UI.blockGetMoreSegments=!1},1e3))))},UI.downOpts),this.firstSegment.waypoint(function(a,b){"up"===b&&(UI.firstSegment.waypoint("remove"),UI.getMoreSegments("before"))},UI.upOpts)},showContextMenu:function(a,b,c){$("#contextMenu").width()+c>$(window).width()&&(c=$(window).width()-$("#contextMenu").width()-30),$("#contextMenu").css({top:b+13+"px",left:c+"px"}).show()},topReached:function(){},browserScrollPositionRestoreCorrection:function(){1==this.firstOpenedSegment&&($(".editor").isOnScreen()||this.autoscrollCorrectionEnabled&&(this.scrollSegment(this.currentSegment),this.autoscrollCorrectionEnabled=!1))},undoInSegment:function(){0===this.undoStackPosition&&this.saveInUndoStack("undo");var a=0;this.undoStack[this.undoStack.length-1-this.undoStackPosition-1]&&(a=this.undoStack.length-1-this.undoStackPosition-1),this.editarea.html(this.undoStack[a]),a||this.lockTags(),this.undoStackPosition<this.undoStack.length-1&&this.undoStackPosition++,this.currentSegment.removeClass("waiting_for_check_result"),this.registerQACheck()},redoInSegment:function(){this.editarea.html(this.undoStack[this.undoStack.length-1-this.undoStackPosition-1+2]),this.undoStackPosition>0&&this.undoStackPosition--,this.currentSegment.removeClass("waiting_for_check_result"),this.registerQACheck()},saveInUndoStack:function(){if(currentItem=this.undoStack[this.undoStack.length-1-this.undoStackPosition],("undefined"==typeof currentItem||currentItem.trim()!=this.editarea.html().trim())&&""!==this.editarea.html()){var a=this.editarea.html().match(/<span.*?contenteditable\="false".*?\>/gi),b=this.editarea.html().match(/&lt;/gi);if(!b||!b.length||a){var c="undefined"!=typeof currentItem?this.dmp.diff_main(currentItem,this.editarea.html())[1][1]:"null";if(" selected"!=c){var d=this.undoStackPosition;d>0&&(this.undoStack.splice(this.undoStack.length-d,d),this.undoStackPosition=0),this.undoStack.push(this.editarea.html().replace(/(<.*?)\s?selected\s?(.*?\>)/gi,"$1$2"))}}}},clearUndoStack:function(){this.undoStack=[]},updateJobMenu:function(){$("#jobMenu li.current").removeClass("current"),$("#jobMenu li:not(.currSegment)").each(function(){$(this).attr("data-file")==UI.currentFileId&&$(this).addClass("current")}),$("#jobMenu li.currSegment").attr("data-segment",UI.currentSegmentId)},zerofill:function(a,b,c){var d=a.toString();for(c||(c="0");d.length<b;)d=c+d;return d}},$(document).ready(function(){APP.init(),APP.fitText($(".breadcrumbs"),$("#pname"),30),setBrowserHistoryBehavior(),$("article").each(function(){APP.fitText($(".filename h2",$(this)),$(".filename h2",$(this)),30)}),UI.render({firstLoad:!0}),UI.checkWarnings(!0),setInterval(function(){UI.checkWarnings(!1)},config.warningPollingInterval)}),$.extend($.expr[":"],{containsNC:function(a,b,c){return(a.textContent||a.innerText||"").toLowerCase().indexOf((c[3]||"").toLowerCase())>=0}}),$(window).resize(function(){}),$.extend(UI,{init:function(){this.initStart=new Date,this.debug&&console.log("Render time: "+(this.initStart-renderStart)),this.numContributionMatchesResults=3,this.numMatchesResults=10,this.numSegments=$("section").length,this.editarea="",this.byButton=!1,this.notYetOpened=!0,this.pendingScroll=0,this.firstScroll=!0,this.blockGetMoreSegments=!0,this.searchParams={},this.searchParams.search=0;var a=$.cookie("noAlertConfirmTranslation");this.alertConfirmTranslationEnabled="undefined"==typeof a?!0:!1,this.customSpellcheck=!1,this.noGlossary=!1,setTimeout(function(){UI.blockGetMoreSegments=!1},1e3),this.detectFirstLast(),this.reinitMMShortcuts(),this.initSegmentNavBar(),rangy.init(),this.savedSel=null,this.savedSelActiveElement=null,this.firstOpenedSegment=!1,this.autoscrollCorrectionEnabled=!0,this.searchEnabled=!0,this.searchEnabled&&$("#filterSwitch").show(),this.viewConcordanceInContextMenu=!0,this.viewConcordanceInContextMenu||$("#searchConcordance").hide(),this.viewSpellCheckInContextMenu=!0,this.viewSpellCheckInContextMenu||$("#spellCheck").hide(),setTimeout(function(){UI.autoscrollCorrectionEnabled=!1},2e3),this.checkSegmentsArray={},this.firstMarking=!0,this.firstMarking=!1,this.setContextMenu(),this.createJobMenu(),$("#alertConfirmTranslation p").text("To confirm your translation, please press on Translated or use the shortcut "+(UI.isMac?"CMD":"CTRL")+"+Enter."),this.setEvents()}}),$.extend(UI,{render:function(a){firstLoad=a.firstLoad||!1,segmentToOpen=a.segmentToOpen||!1,segmentToScroll=a.segmentToScroll||!1,scrollToFile=a.scrollToFile||!1,seg=segmentToOpen||!1,this.segmentToScrollAtRender=seg?seg:!1,this.isWebkit=$.browser.webkit,this.isChrome=$.browser.webkit&&!!window.chrome,this.isFirefox=$.browser.mozilla,this.isSafari=$.browser.webkit&&!window.chrome,this.isMac="MacIntel"==navigator.platform?!0:!1,this.body=$("body"),this.firstLoad=firstLoad,this.initSegNum=200,this.moreSegNum=50,this.loadingMore=!1,this.infiniteScroll=!0,this.noMoreSegmentsAfter=!1,this.noMoreSegmentsBefore=!1,this.blockButtons=!1,this.blockOpenSegment=!1,this.dmp=new diff_match_patch,this.beforeDropEditareaHTML="",this.beforeDropSearchSourceHTML="",this.currentConcordanceField=null,this.droppingInEditarea=!1,this.draggingInsideEditarea=!1,this.undoStack=[],this.undoStackPosition=0,this.ccSourceUndoStack=[],this.ccSourceUndoStackPosition=0,this.ccTargetUndoStack=[],this.ccTargetUndoStackPosition=0,this.tagSelection=!1,this.nextUntranslatedSegmentIdByServer=0,this.cursorPlaceholder="[[placeholder]]",this.openTagPlaceholder="åå",this.closeTagPlaceholder="ΩΩ",this.tempViewPoint="",this.checkUpdatesEvery=18e4,this.autoUpdateEnabled=!0,this.goingToNext=!1,this.preCloseTagAutocomplete=!1,this.globalWarnings=[],this.downOpts={offset:"130%"},this.upOpts={offset:"-40%"},this.readonly=this.body.hasClass("archived")?!0:!1,this.suggestionShortcutLabel="ALT+"+(UI.isMac?"CMD":"CTRL")+"+",this.taglockEnabled=config.taglockEnabled,this.debug=Loader.detect("debug"),this.checkTutorialNeed(),UI.detectStartSegment(),a.openCurrentSegmentAfter=seg||this.firstLoad?!1:!0,UI.getSegments(a),this.firstLoad&&this.autoUpdateEnabled&&(this.lastUpdateRequested=new Date,setTimeout(function(){UI.getUpdates()},UI.checkUpdatesEvery))}}),$.extend(UI,{setEvents:function(){$("body").bind("keydown","Ctrl+return",function(a){a.preventDefault(),$(".editor .translated").click()}).bind("keydown","Meta+return",function(a){a.preventDefault(),$(".editor .translated").click()}).bind("keydown","Ctrl+shift+return",function(a){a.preventDefault(),$(".editor .next-untranslated").click()}).bind("keydown","Meta+shift+return",function(a){a.preventDefault(),$(".editor .next-untranslated").click()}).bind("keydown","Ctrl+pageup",function(a){a.preventDefault()}).bind("keydown","Ctrl+down",function(a){a.preventDefault(),a.stopPropagation(),UI.gotoNextSegment()}).bind("keydown","Meta+down",function(a){a.preventDefault(),a.stopPropagation(),UI.gotoNextSegment()}).bind("keydown","Ctrl+up",function(a){a.preventDefault(),a.stopPropagation(),UI.gotoPreviousSegment()}).bind("keydown","Meta+up",function(a){a.preventDefault(),a.stopPropagation(),UI.gotoPreviousSegment()}).bind("keydown","Ctrl+left",function(a){a.preventDefault(),UI.pointToOpenSegment()}).bind("keydown","Meta+left",function(a){a.preventDefault(),UI.pointToOpenSegment()}).bind("keydown","Ctrl+right",function(a){a.preventDefault(),UI.copySource()}).bind("keydown","Ctrl+shift+major",function(a){a.preventDefault(),UI.copySource()}).bind("keydown","Ctrl+z",function(a){a.preventDefault(),UI.undoInSegment(segment),UI.closeTagAutocompletePanel()}).bind("keydown","Meta+z",function(a){a.preventDefault(),UI.undoInSegment(segment),UI.closeTagAutocompletePanel()}).bind("keydown","Ctrl+y",function(a){a.preventDefault(),UI.redoInSegment(segment)}).bind("keydown","Meta+Shift+z",function(a){a.preventDefault(),UI.redoInSegment(segment)}).bind("keydown","Ctrl+c",function(){UI.tagSelection=!1}).bind("keydown","Meta+c",function(){UI.tagSelection=!1}).bind("keydown","Meta+f",function(a){UI.toggleSearch(a)}).bind("keydown","Ctrl+f",function(a){UI.toggleSearch(a)}).on("change","#hideAlertConfirmTranslation",function(){console.log($(this).prop("checked")),$(this).prop("checked")?(console.log("checked"),UI.alertConfirmTranslationEnabled=!1,$.cookie("noAlertConfirmTranslation",!0,{expires:1e3})):(console.log("unchecked"),UI.alertConfirmTranslationEnabled=!0,$.removeCookie("noAlertConfirmTranslation"))}).on("click","#spellCheck .words",function(a){a.preventDefault(),UI.selectedMisspelledElement.replaceWith($(this).text()),UI.closeContextMenu()}).on("click","#spellCheck .add",function(a){a.preventDefault(),UI.closeContextMenu(),UI.addWord(UI.selectedMisspelledElement.text())}).on("click",".tag-autocomplete li",function(a){a.preventDefault(),UI.editarea.html(UI.editarea.html().replace(/&lt;(?:[a-z]*(?:&nbsp;)*["\w\s\/=]*)?(<span class="tag-autocomplete-endcursor"\>)/gi,"$1")),saveSelection(),$(".rangySelectionBoundary",UI.editarea).length||(setCursorPosition(document.getElementsByClassName("tag-autocomplete-endcursor")[0]),saveSelection());var b=$(".rangySelectionBoundary",UI.editarea)[0].outerHTML;$(".rangySelectionBoundary",UI.editarea).remove(),$(".tag-autocomplete-endcursor",UI.editarea).after(b),$(".tag-autocomplete-endcursor").before(htmlEncode($(this).text())),restoreSelection(),UI.closeTagAutocompletePanel(),UI.lockTags(UI.editarea),UI.currentSegmentQA()}),$(window).on("scroll",function(){UI.browserScrollPositionRestoreCorrection()}),$("header .filter").click(function(a){a.preventDefault(),UI.body.toggleClass("filtering")}),$("#filterSwitch").bind("click",function(a){UI.toggleSearch(a)}),$("#segmentPointer").click(function(a){a.preventDefault(),UI.pointToOpenSegment()}),$(".replace").click(function(a){a.preventDefault(),UI.body.toggleClass("replace-box")}),jQuery(".editarea").trigger("update"),$("div.notification-box").mouseup(function(){return!1}),$(".search-icon, .search-on").click(function(a){a.preventDefault(),$("#search").toggle()}),$(".download-chrome a.close").bind("click",function(a){a.preventDefault(),$(".download-chrome").removeClass("d-open")}),$(".x-stats").click(function(){$(".stats").toggle()}),$(window).on("sourceCopied",function(){}),$("#outer").on("click","a.sid",function(a){return a.preventDefault(),a.stopPropagation(),!1}).on("click","a.status",function(a){a.preventDefault(),a.stopPropagation()}).on("click","section:not(.readonly) a.status",function(){console.log("status");var a=$(this).parents("section"),b=$("ul.statusmenu",a);UI.createStatusMenu(b),b.show();$("html").bind("click.vediamo",function(){$("ul.statusmenu").hide(),$("html").unbind("click.vediamo"),UI.removeStatusMenu(b)})}).on("click","section.readonly, section.readonly a.status",function(a){a.preventDefault(),UI.justSelecting("readonly")||UI.someUserSelection||(UI.selectingReadonly=setTimeout(function(){APP.alert({msg:"This part has not been assigned to you."})},200))}).on("mousedown","section.readonly, section.readonly a.status",function(){sel=window.getSelection(),UI.someUserSelection="Range"==sel.type?!0:!1}).on("dblclick","section.readonly",function(){clearTimeout(UI.selectingReadonly)}).on("blur",".graysmall .translation",function(a){a.preventDefault(),UI.closeInplaceEditor($(this))}).on("click",".graysmall .edit-buttons .cancel",function(a){a.preventDefault(),UI.closeInplaceEditor($(this).parents(".graysmall").find(".translation"))}).on("click",".graysmall .edit-buttons .save",function(a){a.preventDefault(),console.log("save"),ed=$(this).parents(".graysmall").find(".translation"),UI.editContribution(UI.currentSegment,$(this).parents(".graysmall")),UI.closeInplaceEditor(ed)}),$(".joblink").click(function(a){return a.preventDefault(),$(".joblist").toggle(),!1}),$(".statslink").click(function(a){a.preventDefault(),a.stopPropagation(),$(".stats").toggle()}),$(".getoriginal").click(function(a){a.preventDefault(),$("#originalDownload").submit()}),$("form#fileDownload").bind("submit",function(a){a.preventDefault()}),$("html").click(function(){$(".menucolor").hide()}).on("click","#downloadProject",function(a){a.preventDefault(),$("#notifbox").hasClass("warningbox")?APP.confirm({name:"confirmDownload",cancelTxt:"Fix errors",onCancel:"goToFirstError",callback:"continueDownload",okTxt:"Continue",msg:'Potential errors (missing tags, numbers etc.) found in the text. <br>If you continue, part of the content could be untranslated - look for the string "UNTRANSLATED_CONTENT" in the downloaded file(s).<br><br>Continue downloading or fix the error in MateCat:'}):UI.continueDownload()}).on("click",".alert .close",function(a){a.preventDefault(),$(".alert").remove()}).on("click",".downloadtr-button .draft",function(){UI.isChrome&&($(".download-chrome").addClass("d-open"),setTimeout(function(){$(".download-chrome").removeClass("d-open")},7e3))}).on("click","#contextMenu #searchConcordance",function(){$("#contextMenu").attr("data-sid")==UI.currentSegmentId?UI.openConcordance():$("#segment-"+$("#contextMenu").attr("data-sid")+" .editarea").trigger("click",["clicking","openConcordance"])}),$("#outer").on("click","a.percentuage",function(a){a.preventDefault(),a.stopPropagation()}).on("click",".editarea",function(a,b,c){"undefined"==typeof b&&(b="clicking"),this.onclickEditarea=new Date,UI.notYetOpened=!1,UI.closeTagAutocompletePanel(),$(this).is(UI.editarea)&&""!==UI.editarea&&UI.body.hasClass("editing")||("moving"==b?("moving"==UI.lastOperation&&UI.recentMoving?(UI.segmentToOpen=segment,UI.blockOpenSegment=!0,console.log("ctrl+down troppo vicini")):UI.blockOpenSegment=!1,UI.recentMoving=!0,clearTimeout(UI.recentMovingTimeout),UI.recentMovingTimeout=setTimeout(function(){UI.recentMoving=!1},1e3)):UI.blockOpenSegment=!1,UI.lastOperation=b,UI.openSegment(this,b),"openConcordance"==c&&UI.openConcordance(),"moving"!=b&&UI.scrollSegment($("#segment-"+$(this).data("sid")))),UI.debug&&console.log("Total onclick Editarea: "+(new Date-this.onclickEditarea))}).on("keydown",".editor .source, .editor .editarea","alt+meta+c",function(a){a.preventDefault(),UI.preOpenConcordance()}).on("keydown",".editor .source, .editor .editarea","alt+ctrl+c",function(a){a.preventDefault(),UI.preOpenConcordance()}).on("keypress",".editor .editarea",function(a){if(60==a.which&&UI.taglockEnabled){if($(".tag-autocomplete").length)return a.preventDefault(),!1;UI.openTagAutocompletePanel()}return 62==a.which&&UI.taglockEnabled&&$(".tag-autocomplete").length?(a.preventDefault(),!1):void setTimeout(function(){$(".tag-autocomplete").length&&(null!==UI.editarea.html().match(/^(<span class="tag-autocomplete-endcursor"\><\/span>&lt;)/gi)&&UI.editarea.html(UI.editarea.html().replace(/^(<span class="tag-autocomplete-endcursor"\><\/span>&lt;)/gi,'&lt;<span class="tag-autocomplete-endcursor"></span>')),UI.checkAutocompleteTags())},50)}).on("keydown",".editor .editarea",function(a){var b="keypress"!==event.type&&jQuery.hotkeys.specialKeys[event.which];if((event.metaKey&&!event.ctrlKey&&"meta"!==b||event.ctrlKey)&&88==event.which&&$(".selected",$(this)).length&&(event.preventDefault(),UI.tagSelection=getSelectionHtml(),$(".selected",$(this)).remove()),8==a.which||46==a.which)if($(".selected",$(this)).length)console.log("a"),a.preventDefault(),$(".selected",$(this)).remove(),UI.saveInUndoStack("cancel"),UI.currentSegmentQA();else{var c=UI.editarea.text().match(/<.*?\>/gi).length,d=UI.editarea.text().match(/\s/gi).length;console.log(UI.editarea.html()),saveSelection(),console.log(UI.editarea.html()),parentTag=$("span.locked",UI.editarea).has(".rangySelectionBoundary"),isInsideTag=$("span.locked .rangySelectionBoundary",UI.editarea).length,restoreSelection(),8==a.which&&isInsideTag&&console.log("inside tag"),console.log(a.which+" - "+isInsideTag),setTimeout(function(){46==a.which&&isInsideTag&&console.log("inside tag"),console.log(a.which+" - "+isInsideTag);var b=UI.editarea.text().match(/<.*?\>/gi).length,e=UI.editarea.text().match(/\s/gi).length;c>b&&UI.saveInUndoStack("cancel"),d>e&&UI.saveInUndoStack("cancel"),console.log("QUI: ",UI.editarea.html())},50)}if(8==a.which&&$(".tag-autocomplete").length&&(UI.closeTagAutocompletePanel(),setTimeout(function(){UI.openTagAutocompletePanel(),added=UI.getPartialTagAutocomplete(),""===added&&UI.closeTagAutocompletePanel()},10)),37==a.which&&(selection=window.getSelection(),range=selection.getRangeAt(0),range.startOffset!=range.endOffset&&(r=range.startContainer.data,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).first().get(0),rr.setStartBefore(referenceNode),rr.setEndBefore(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove())),UI.closeTagAutocompletePanel(),UI.jumpTag("")),38==a.which){if($(".tag-autocomplete").length&&!$(".tag-autocomplete li.current").is($(".tag-autocomplete li:first")))return $(".tag-autocomplete li.current:not(:first-child)").removeClass("current").prevAll(":not(.hidden)").first().addClass("current"),!1;selection=window.getSelection(),range=selection.getRangeAt(0),range.startOffset!=range.endOffset&&(r=range.startContainer.data,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).last().get(0),rr.setStartAfter(referenceNode),rr.setEndAfter(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove()))}if(39==a.which&&(selection=window.getSelection(),range=selection.getRangeAt(0),range.startOffset!=range.endOffset&&(r=range.startContainer.data,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).last().get(0),rr.setStartAfter(referenceNode),rr.setEndAfter(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove())),UI.closeTagAutocompletePanel(),UI.jumpTag("end")),40==a.which){if($(".tag-autocomplete").length)return $(".tag-autocomplete li.current:not(:last-child)").removeClass("current").nextAll(":not(.hidden)").first().addClass("current"),!1;selection=window.getSelection(),range=selection.getRangeAt(0),range.startOffset!=range.endOffset&&(r=range.startContainer.data,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).last().get(0),rr.setStartAfter(referenceNode),rr.setEndAfter(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove()))}return 37!=a.which&&38!=a.which&&39!=a.which&&40!=a.which&&UI.body.hasClass("searchActive")&&UI.resetSearch(),32==a.which&&setTimeout(function(){UI.saveInUndoStack("space")},100),13==a.which&&$(".tag-autocomplete").length?($(".tag-autocomplete li.current").click(),!1):void((13==a.which||32==a.which||49==a.which||188==a.which||186==a.which||190==a.which||191==a.which||222==a.which)&&UI.spellCheck())}).on("input",".editarea",function(){UI.body.hasClass("searchActive")&&UI.resetSearch(),UI.currentSegment.addClass("modified").removeClass("waiting_for_check_result"),UI.draggingInsideEditarea&&($(UI.tagToDelete).remove(),UI.draggingInsideEditarea=!1,UI.tagToDelete=null),UI.droppingInEditarea&&UI.cleanDroppedTag(UI.editarea,UI.beforeDropEditareaHTML),UI.body.hasClass("searchActive")||setTimeout(function(){UI.lockTags(UI.editarea)},10),UI.registerQACheck()}).on("input",".editor .cc-search .input",function(){UI.markTagsInSearch($(this))}).on("click",".editor .source .locked,.editor .editarea .locked",function(a){a.preventDefault(),a.stopPropagation(),setCursorPosition(this),selectText(this),$(this).toggleClass("selected")}).on("mousedown",".source",function(a){return 2==a.button?!0:!0}).on("dragstart",".editor .editarea .locked",function(){var a=window.getSelection(),b=a.getRangeAt(0);return b.startContainer.data!=b.endContainer.data?!1:(UI.draggingInsideEditarea=!0,void(UI.tagToDelete=$(this)))}).on("drop",".editor .editarea",function(a){a.stopPropagation&&a.stopPropagation(),UI.beforeDropEditareaHTML=UI.editarea.html(),UI.droppingInEditarea=!0,$(window).trigger({type:"droppedInEditarea",segment:UI.currentSegment}),UI.saveInUndoStack("drop"),setTimeout(function(){UI.saveInUndoStack("drop")},100)}).on("drop paste",".editor .cc-search .input, .editor .gl-search .input",function(){UI.beforeDropSearchSourceHTML=UI.editarea.html(),UI.currentConcordanceField=$(this),setTimeout(function(){UI.cleanDroppedTag(UI.currentConcordanceField,UI.beforeDropSearchSourceHTML)},100)}).on("click",".editor .editarea .locked.selected",function(){}).on("click",".editor .editarea, .editor .source",function(){$(".selected",$(this)).removeClass("selected"),UI.currentSelectedText=!1,UI.currentSearchInTarget=!1,$("#contextMenu").hide()}).on("click","a.translated, a.next-untranslated",function(a){var b=$(this).hasClass("translated")?"translated":"next-untranslated";a.preventDefault(),UI.currentSegment.removeClass("modified");var c=!1;return"next-untranslated"==b?(console.log("entra"),UI.segmentIsLoaded(UI.nextUntranslatedSegmentId)||(UI.changeStatus(this,"translated",0),c=!0,UI.nextUntranslatedSegmentId?UI.reloadWarning():$("#"+$(this).attr("data-segmentid")+"-close").click())):$(UI.currentSegment).nextAll("section").length||(UI.changeStatus(this,"translated",0),c=!0,$("#"+$(this).attr("data-segmentid")+"-close").click()),UI.checkHeaviness(),UI.blockButtons?void(UI.segmentIsLoaded(UI.nextUntranslatedSegmentId)||""===UI.nextUntranslatedSegmentId?console.log("segment is already loaded"):(console.log("segment is not loaded"),UI.noMoreSegmentsAfter||UI.reloadWarning())):(UI.blockButtons=!0,UI.unlockTags(),UI.setStatusButtons(this),c||UI.changeStatus(this,"translated",0),"translated"==b?UI.gotoNextSegment():$(".editarea",UI.nextUntranslatedSegment).trigger("click","translated"),UI.markTags(),UI.lockTags(UI.editarea),UI.changeStatusStop=new Date,void(UI.changeStatusOperations=UI.changeStatusStop-UI.buttonClickStop))}).on("click","a.approved",function(){UI.setStatusButtons(this),$(".editarea",UI.nextUntranslatedSegment).click(),UI.changeStatus(this,"approved",0),UI.changeStatusStop=new Date,UI.changeStatusOperations=UI.changeStatusStop-UI.buttonClickStop}).on("click","a.d, a.a, a.r, a.f",function(){var a=$(this).parents("section");return $("a.status",a).removeClass("col-approved col-rejected col-done col-draft"),$("ul.statusmenu",a).toggle(),!1}).on("click","a.d",function(){UI.changeStatus(this,"translated",1)}).on("click","a.a",function(){UI.changeStatus(this,"approved",1)}).on("click","a.r",function(){UI.changeStatus(this,"rejected",1)
}).on("click","a.f",function(){UI.changeStatus(this,"draft",1)}).on("click",".editor .outersource .copy",function(a){a.preventDefault(),UI.copySource()}).on("click",".tagmenu, .warning, .viewer, .notification-box li a",function(){return!1}).on("click",".tab-switcher-tm",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.matches").show()}).on("click",".tab-switcher-cc",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.concordances").show(),$(".cc-search .search-source").focus()}).on("click",".tab-switcher-gl",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.glossary").show(),$(".gl-search .search-source").focus()}).on("click",".sub-editor.glossary .overflow a.trash",function(a){a.preventDefault(),ul=$(this).parents("ul.graysmall").first(),UI.deleteGlossaryItem($(this).parents("ul.graysmall").first())}).on("click",".sub-editor.glossary .details .comment",function(a){a.preventDefault(),$(this).attr("contenteditable",!0).focus()}).on("blur",".sub-editor.glossary .details .comment",function(a){a.preventDefault(),$(this).attr("contenteditable",!1),item=$(this).parents(".graysmall"),APP.doRequest({data:{action:"glossary",exec:"update",segment:item.find(".suggestion_source").text(),translation:item.find(".translation").text(),comment:$(this).text(),id_item:item.attr("data-id"),id_job:config.job_id,password:config.password},context:[UI.currentSegment,next],success:function(){},complete:function(){}})}).on("keydown",".sub-editor .cc-search .search-source",function(a){if(13==a.which){a.preventDefault();var b=$(this).text();b.length>1&&UI.getConcordance(b,0)}else $(".editor .sub-editor .cc-search .search-target").text().length>0&&($(".editor .sub-editor .cc-search .search-target").text(""),$(".editor .sub-editor.concordances .results").empty())}).on("keydown",".sub-editor .cc-search .search-target",function(a){if(13==a.which){a.preventDefault();var b=$(this).text();b.length>2&&UI.getConcordance(b,1)}else $(".editor .sub-editor .cc-search .search-source").text().length>0&&($(".editor .sub-editor .cc-search .search-source").text(""),$(".editor .sub-editor.concordances .results").empty())}).on("click",".sub-editor .gl-search .search-glossary",function(a){a.preventDefault();var b=$(this).parents(".gl-search").find(".search-source").text();segment=$(this).parents("section").first(),b.length>1?UI.getGlossary(segment,!1):APP.alert({msg:"Please insert a string of two letters at least!"})}).on("keydown",".sub-editor .gl-search .search-source",function(a){if(13==a.which){a.preventDefault();var b=$(this).text();b.length>2&&(segment=$(this).parents("section").first(),UI.getGlossary(segment,!1))}}).on("input",".sub-editor .gl-search .search-target",function(){gl=$(this).parents(".gl-search").find(".set-glossary"),""===$(this).text()?gl.addClass("disabled"):gl.removeClass("disabled")}).on("click",".sub-editor .gl-search .set-glossary",function(a){a.preventDefault()}).on("click",".sub-editor .gl-search .set-glossary:not(.disabled)",function(a){return a.preventDefault(),""===$(this).parents(".gl-search").find(".search-source").text()?(APP.alert({msg:"Please insert a glossary term."}),!1):void UI.setGlossaryItem()}).on("click",".sub-editor .gl-search .comment a",function(a){a.preventDefault(),$(this).parents(".comment").find(".gl-comment").toggle()}).on("paste",".editarea",function(a){UI.saveInUndoStack("paste"),$("#placeHolder").remove();var b=document.createElement("div");b.setAttribute("id","placeHolder"),removeSelectedText($(this)),insertNodeAtCursor(b),UI.isFirefox&&pasteHtmlAtCaret('<div id="placeHolder"></div>');var c=UI.isFirefox?a:event;handlepaste(this,c),$(window).trigger({type:"pastedInEditarea",segment:segment}),setTimeout(function(){UI.saveInUndoStack("paste")},100),UI.lockTags(UI.editarea),UI.currentSegmentQA()}).on("click","a.close",function(a,b){a.preventDefault();var c="undefined"==typeof b?"noSave":b;UI.closeSegment(UI.currentSegment,1,c)}).on("keyup",".editor .editarea",function(a){13==a.which}),UI.toSegment=!0,this.segmentToScrollAtRender||UI.gotoSegment(this.startSegmentId),$(".end-message-box a.close").on("click",function(a){a.preventDefault(),UI.body.removeClass("justdone")}),this.checkIfFinishedFirst(),$("section .close").bind("keydown","Shift+tab",function(a){a.preventDefault(),$(this).parents("section").find("a.translated").focus()}),$("a.translated").bind("keydown","tab",function(a){a.preventDefault(),$(this).parents("section").find(".close").focus()}),$("#navSwitcher").on("click",function(a){a.preventDefault()}),$("#pname").on("click",function(a){a.preventDefault(),UI.toggleFileMenu()}),$("#jobNav .jobstart").on("click",function(a){a.preventDefault(),UI.scrollSegment($("#segment-"+config.firstSegmentOfFiles[0].first_segment))}),$("#jobMenu").on("click","li:not(.currSegment)",function(a){a.preventDefault(),UI.renderAndScrollToSegment($(this).attr("data-segment"),!0)}),$("#jobMenu").on("click","li.currSegment",function(a){a.preventDefault(),UI.pointToOpenSegment()}),$("#jobNav .prevfile").on("click",function(a){a.preventDefault(),currArtId=$(UI.currentFile).attr("id").split("-")[1],$.each(config.firstSegmentOfFiles,function(){currArtId==this.id_file&&(firstSegmentOfCurrentFile=this.first_segment)}),UI.scrollSegment($("#segment-"+firstSegmentOfCurrentFile))}),$("#jobNav .currseg").on("click",function(a){a.preventDefault(),$("#segment-"+UI.currentSegmentId).length?UI.scrollSegment(UI.currentSegment):($("#outer").empty(),UI.render({firstLoad:!1}))}),$("#jobNav .nextfile").on("click",function(a){a.preventDefault(),""===UI.tempViewPoint&&(currFileFirstSegmentId=$(UI.currentFile).attr("id").split("-")[1],$.each(config.firstSegmentOfFiles,function(){this.id_file==currFileFirstSegmentId&&(firstSegId=this.first_segment)}),UI.scrollSegment($("#segment-"+firstSegId)),UI.tempViewPoint=$(UI.currentFile).attr("id").split("-")[1]),$.each(config.firstSegmentOfFiles,function(){console.log(this.id_file)})}),$(".searchbox input, .searchbox select").bind("keydown","return",function(a){a.preventDefault(),"disabled"!=$("#exec-find").attr("disabled")&&$("#exec-find").click()}),$("#exec-find").click(function(a){a.preventDefault(),"find"==$(this).attr("data-func")?UI.execFind():UI.goingToNext||(UI.goingToNext=!0,UI.execNext())}),$("#exec-cancel").click(function(a){a.preventDefault(),$("#filterSwitch").click(),UI.body.removeClass("searchActive"),UI.clearSearchMarkers(),UI.clearSearchFields(),UI.setFindFunction("find"),$("#exec-find").removeAttr("disabled"),$("#exec-replace, #exec-replaceall").attr("disabled","disabled"),UI.enableTagMark(),UI.segmentIsLoaded(UI.currentSegmentId)?UI.gotoOpenSegment():UI.render({firstLoad:!1,segmentToOpen:UI.currentSegmentId})}),$("#exec-replaceall").click(function(a){a.preventDefault(),APP.confirm({name:"confirmReplaceAll",cancelTxt:"Cancel",callback:"execReplaceAll",okTxt:"Continue",msg:"Do you really want to replace this text in all search results? <br>(The page will be refreshed after confirm)"})}),$("#exec-replace").click(function(a){return a.preventDefault(),$("#search-target").val()==$("#replace-target").val()?(APP.alert({msg:"Attention: you are replacing the same text!"}),!1):void("onlyStatus"==UI.searchMode||"source&target"==UI.searchMode||(txt=$("#replace-target").val(),$("mark.currSearchItem").text(txt),segment=$("mark.currSearchItem").parents("section"),UI.setTranslation(segment,UI.getStatus(segment),"replace"),UI.updateSearchDisplayCount(segment),$(segment).attr("data-searchItems",$("mark.searchMarker",segment).length),UI.gotoNextResultItem(!0)))}),$("#enable-replace").on("change",function(){$("#enable-replace").is(":checked")&&""!==$("#search-target").val()?$("#replace-target, #exec-replace, #exec-replaceall").removeAttr("disabled"):$("#replace-target, #exec-replace, #exec-replaceall").attr("disabled","disabled")}),$("#search-source, #search-target").on("input",function(){UI.checkSearchChanges()&&UI.setFindFunction("find")}),$("#search-target").on("input",function(){""===$(this).val()?$("#replace-target, #exec-replace, #exec-replaceall").attr("disabled","disabled"):$("#enable-replace").is(":checked")&&$("#replace-target, #exec-replace, #exec-replaceall").removeAttr("disabled")}),$("#select-status").on("change",function(){UI.checkSearchChanges()&&UI.setFindFunction("find")}),$("#match-case, #exact-match").on("change",function(){UI.setFindFunction("find")}),this.initEnd=new Date,this.initTime=this.initEnd-this.initStart,this.debug&&console.log("Init time: "+this.initTime)}}),$.extend(UI,{chooseSuggestion:function(a){this.copySuggestionInEditarea(this.currentSegment,$(".editor ul[data-item="+a+"] li.b .translation").text(),$(".editor .editarea"),$(".editor ul[data-item="+a+"] ul.graysmall-details .percent").text(),!1,!1,a),this.lockTags(this.editarea),this.setChosenSuggestion(a),this.editarea.focus().effect("highlight",{},1e3)},copySuggestionInEditarea:function(a,b,c,d,e,f,g){"undefined"==typeof e&&(e=!1),percentageClass=this.getPercentuageClass(d),""!==$.trim(b)&&(e&&(b=htmlDecode(b)),this.body.hasClass("searchActive")&&this.addWarningToSearchDisplay(),this.saveInUndoStack("copysuggestion"),$(c).text(b).addClass("fromSuggestion"),this.saveInUndoStack("copysuggestion"),$(".percentuage",a).text(d).removeClass("per-orange per-green per-blue per-yellow").addClass(percentageClass).addClass("visible"),g&&this.currentSegment.addClass("modified")),$(window).trigger({type:"suggestionChosen",segment:UI.currentSegment,element:UI.editarea,which:g,translation:b})},getContribution:function(a,b){var c=$(0===b?a:1==b?"#segment-"+this.nextSegmentId:"#segment-"+this.nextUntranslatedSegmentId);if($(c).hasClass("loaded"))return this.spellCheck(),b?this.nextIsLoaded=!0:this.currentIsLoaded=!0,this.currentIsLoaded&&(this.blockButtons=!1),this.currentSegmentId==this.nextUntranslatedSegmentId&&(this.blockButtons=!1),b||this.currentSegmentQA(),!1;if(!c.length&&b)return!1;var d=c.attr("id"),e=d.split("-")[1],f=$(".source",c).text();f=view2rawxliff(f),b||$(".loader",c).addClass("loader_on"),APP.doRequest({data:{action:"getContribution",password:config.password,is_concordance:0,id_segment:e,text:f,id_job:config.job_id,num_results:this.numContributionMatchesResults,id_translator:config.id_translator},context:$("#"+d),success:function(a){UI.getContribution_success(a,this)},complete:function(){UI.getContribution_complete(c)}})},getContribution_complete:function(a){$(".loader",a).removeClass("loader_on")},getContribution_success:function(a,b){this.renderContributions(a,b),$(b).attr("id").split("-")[1]==UI.currentSegmentId&&this.currentSegmentQA(),this.lockTags(this.editarea),this.spellCheck(),this.saveInUndoStack(),this.blockButtons=!1,a.data.matches.length>0?$(".submenu li.matches a span",b).text("("+a.data.matches.length+")"):$(".sbm > .matches",b).hide()},renderContributions:function(a,b){var c=$(b).hasClass("editor"),d=$(".editarea",b);if(a.data.matches.length){var e=d.text().trim().length;c?d.removeClass("indent"):0===e&&d.addClass("indent");var f=a.data.matches[0].translation,g=$(".percentuage",b).attr("title");$(".percentuage",b).attr("title",""+g+"Created by "+a.data.matches[0].created_by);var h=a.data.matches[0].match,i=!1;0===e&&(UI.copySuggestionInEditarea(b,f,d,h,!0,!0,0),UI.body.hasClass("searchActive")&&UI.addWarningToSearchDisplay(),UI.setChosenSuggestion(1),i=!0);var j=b.attr("id");$(b).addClass("loaded"),$(".sub-editor.matches .overflow",b).empty(),$.each(a.data.matches,function(a){if(""!==this.segment&&""!==this.translation){var c="0"==this.id?!0:!1;cb=this.created_by,suggestion_info="sentence_confidence"in this&&""!==this.sentence_confidence&&0!==this.sentence_confidence&&"0"!=this.sentence_confidence&&null!==this.sentence_confidence&&this.sentence_confidence!==!1&&"undefined"!=typeof this.sentence_confidence?"Quality: <b>"+this.sentence_confidence+"</b>":"MT"!=this.match?this.last_update_date:"",cl_suggestion=UI.getPercentuageClass(this.match),$(".sub-editor.matches",b).length||UI.createFooter(b),escapedSegment=UI.decodePlaceholdersToText(this.segment),$(".sub-editor.matches .overflow",b).append('<ul class="graysmall" data-item="'+(a+1)+'" data-id="'+this.id+'"><li class="sugg-source">'+(c?"":' <a id="'+j+"-tm-"+this.id+'-delete" href="#" class="trash" title="delete this row"></a>')+'<span id="'+j+"-tm-"+this.id+'-source" class="suggestion_source">'+escapedSegment+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span class="graysmall-message">'+UI.suggestionShortcutLabel+(a+1)+'</span><span id="'+j+"-tm-"+this.id+'-translation" class="translation">'+UI.decodePlaceholdersToText(this.translation)+'</span></li><ul class="graysmall-details"><li class="percent '+cl_suggestion+'">'+this.match+"</li><li>"+suggestion_info+'</li><li class="graydesc">Source: <span class="bold">'+cb+"</span></li></ul></ul>")}}),UI.markSuggestionTags(b),UI.setDeleteSuggestion(b),UI.lockTags(),$(".translated",b).removeAttr("disabled"),$(".draft",b).removeAttr("disabled")}else UI.debug&&console.log("no matches"),$(b).addClass("loaded"),$(".sub-editor.matches .overflow",b).append('<ul class="graysmall message"><li>Sorry. Can\'t help you this time. Check the language pair if you feel this is weird.</li></ul>')},setContribution:function(a,b,c){return"draft"==b||"rejected"==b?!1:(config.brPlaceholdEnabled?(source=this.postProcessEditarea(a,".source"),target=this.postProcessEditarea(a)):(source=$(".source",a).text(),target=$(".editarea",a).text()),""===target&&c&&APP.alert({msg:"Cannot change status on an empty segment. Add a translation first!"}),""===target?!1:void this.updateContribution(source,target))},updateContribution:function(a,b){a=view2rawxliff(a),b=view2rawxliff(b),APP.doRequest({data:{action:"setContribution",id_job:config.job_id,source:a,target:b,source_lang:config.source_lang,target_lang:config.target_lang,password:config.password,id_translator:config.id_translator,private_translator:config.private_translator,id_customer:config.id_customer,private_customer:config.private_customer},success:function(a){a.error.length&&UI.processErrors(a.error,"setContribution")}})},setContributionMT:function(a,b,c){if("draft"==b||"rejected"==b)return!1;var d=$(".source",a).text();d=view2rawxliff(d);var e=$(".editarea",a).text();if(""===e&&c&&APP.alert({msg:"Cannot change status on an empty segment. Add a translation first!"}),""===e)return!1;e=view2rawxliff(e);var f=$(a).parents("article").find(".languages"),g=($(".source-lang",f).text(),$(".target-lang",f).text(),config.id_translator,config.private_translator,config.id_customer,config.private_customer,$(a).attr("id").split("-")),h=g[1],i=UI.editTime,j=$(".editarea",a).data("lastChosenSuggestion");APP.doRequest({data:{action:"setContributionMT",id_segment:h,source:d,target:e,source_lang:config.source_lang,target_lang:config.target_lang,password:config.password,time_to_edit:i,id_job:config.job_id,chosen_suggestion_index:j},success:function(a){a.error.length&&UI.processErrors(a.error,"setContributionMT")}})},setDeleteSuggestion:function(a){$(".sub-editor .overflow a.trash",a).click(function(a){a.preventDefault();var b=$(this).parents(".graysmall");config.brPlaceholdEnabled?(source=UI.postProcessEditarea(b,".suggestion_source"),target=UI.postProcessEditarea(b,".translation")):(source=$(".suggestion_source",b).text(),target=$(".translation",b).text()),target=view2rawxliff(target),source=view2rawxliff(source),b.remove(),APP.doRequest({data:{action:"deleteContribution",source_lang:config.source_lang,target_lang:config.target_lang,id_job:config.job_id,password:config.password,seg:source,tra:target,id_translator:config.id_translator},success:function(a){UI.setDeleteSuggestion_success(a)}})})},setDeleteSuggestion_success:function(a){a.error.length&&this.processErrors(a.error,"setDeleteSuggestion"),this.debug&&console.log("match deleted"),$(".editor .matches .graysmall").each(function(a){$(this).find(".graysmall-message").text(UI.suggestionShortcutLabel+(a+1)),$(this).attr("data-item",a+1),UI.reinitMMShortcuts()})},reinitMMShortcuts:function(){var a=this.isMac?"alt+meta":"alt+ctrl";$("body").unbind("keydown.alt1").unbind("keydown.alt2").unbind("keydown.alt3").unbind("keydown.alt4").unbind("keydown.alt5"),$("body, .editarea").bind("keydown.alt1",a+"+1",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("1")}).bind("keydown.alt2",a+"+2",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("2")}).bind("keydown.alt3",a+"+3",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("3")}).bind("keydown.alt4",a+"+4",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("4")}).bind("keydown.alt5",a+"+5",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("5")})},setChosenSuggestion:function(a){this.editarea.data("lastChosenSuggestion",a)}}),$.extend(UI,{noTagsInSegment:function(a){if(!this.editarea&&"undefined"==typeof a)return!0;if("undefined"!=typeof a)return!1;var b=$(".source",this.currentSegment).html().match(/\&lt;.*?\&gt;/gi),c=this.editarea.html().match(/\&lt;.*?\&gt;/gi);return b||c?!1:!0},tagCompare:function(a,b,c){for(var d=!1,e=0;e<a.length;e++)for(var f=0;f<b.length;f++)a[e]==b[f]&&(a.splice(e,1),b.splice(f,1),UI.tagCompare(a,b,c++));return d=a.length||b.length?!0:!1},detectTags:function(a){$(a).html($(a).html().replace(/(:?<span.*?>)?(&lt;\s*\/*\s*(g|x|bx|ex|bpt|ept|ph[^a-z]|it|mrk)\s*.*?&gt;)(:?<\/span>)?/gi,'<span contenteditable="true" class="locked">$2</span>'))},disableTagMark:function(){this.taglockEnabled=!1,this.body.addClass("tagmarkDisabled"),$(".source span.locked").each(function(){$(this).replaceWith($(this).html())}),$(".editarea span.locked").each(function(){$(this).replaceWith($(this).html())})},enableTagMark:function(){console.log("enable tag mark"),this.taglockEnabled=!0,this.body.removeClass("tagmarkDisabled"),saveSelection(),this.markTags(),restoreSelection()},markSuggestionTags:function(a){return this.taglockEnabled?($(".footer .suggestion_source",a).each(function(){$(this).html($(this).html().replace(/(&lt;(g|x|bx|ex|bpt|ept|ph|it|mrk)\sid.*?&gt;)/gi,'<span contenteditable="false" class="locked">$1</span>')),$(this).html(UI.isFirefox?$(this).html().replace(/(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"):$(this).html().replace(/(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"))}),void $(".footer .translation").each(function(){$(this).html($(this).html().replace(/(&lt;(g|x|bx|ex|bpt|ept|ph|it|mrk)\sid.*?&gt;)/gi,'<span contenteditable="false" class="locked">$1</span>')),$(this).html(UI.isFirefox?$(this).html().replace(/(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"):$(this).html().replace(/(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"))})):!1},markTags:function(){return this.taglockEnabled?this.noTagsInSegment(1)?!1:($(".source").each(function(){UI.detectTags(this)}),void $(".editarea").each(function(){return $("#segment-"+$(this).data("sid")).hasClass("mismatch")?!1:void UI.detectTags(this)})):!1},markTagsInSearch:function(a){if(!this.taglockEnabled)return!1;var b="undefined"==typeof a?$(".editor .cc-search .input"):a;b.each(function(){})},lockTags:function(a){return this.body.hasClass("tagmarkDisabled")?!1:(editarea="undefined"==typeof a?UI.editarea:a,this.taglockEnabled?this.noTagsInSegment()?!1:void $(editarea).first().each(function(){saveSelection();var a=$(this).html();brTx1=UI.isFirefox?'<pl class="locked" contenteditable="true">$1</pl>':'<pl contenteditable="true" class="locked">$1</pl>',brTx2=UI.isFirefox?'<span class="locked" contenteditable="true">$1</span>':'<span contenteditable="true" class="locked">$1</span>',a=a.replace(/<span/gi,"<pl").replace(/<\/span/gi,"</pl").replace(/&lt;/gi,"<").replace(/(<(g|x|bx|ex|bpt|ept|ph[^a-z]*|it|mrk)\sid[^<]*?&gt;)/gi,brTx1).replace(/</gi,"&lt;").replace(/\&lt;pl/gi,"<span").replace(/\&lt;\/pl/gi,"</span").replace(/\&lt;div\>/gi,"<div>").replace(/\&lt;\/div\>/gi,"</div>").replace(/\&lt;br\>/gi,"<br>").replace(/\&lt;br class=["\'](.*?)["\'][\s]*[\/]*(\&gt;|\>)/gi,'<br class="$1" />').replace(/(&lt;\s*\/\s*(g|x|bx|ex|bpt|ept|ph|it|mrk)\s*&gt;)/gi,brTx2),a=UI.isFirefox?a.replace(/(<span class=\"[^>]*locked[^>]*\" contenteditable=\"true\"\>)(:?\1)(.*?)(<\/span\>){2}/gi,"$1$3</span>"):a.replace(/(<span contenteditable=\"true\" class=\"[^>]*locked[^>]*\"\>)(:?\1)(.*?)(<\/span\>){2}/gi,"$1$3</span>"),a=a.replace(/(<\/span\>)$(\s){0,}/gi,"</span> ");var b=$("span.locked",this).length;$(this).html(a),restoreSelection(),$("span.locked",this).length!=b&&UI.closeTagAutocompletePanel()}):!1)},unlockTags:function(){return this.taglockEnabled?void this.editarea.html(this.editarea.html().replace(/<span contenteditable=\"true\" class=\"locked\"\>(.*?)<\/span\>/gi,"$1")):!1},cleanDroppedTag:function(a,b){a==this.editarea&&(this.droppingInEditarea=!1);var c=this.dmp.diff_main(b,$(a).html()),d="";$(c).each(function(){1==this[0]&&(d+=this[1])}),d=d.replace(/^(\&nbsp;)(.*?)(\&nbsp;)$/gi,"$2");var e=document.createElement("div");e.innerHTML=d,saveSelection();var f=$(".rangySelectionBoundary")[0].outerHTML;$(".rangySelectionBoundary").text(this.cursorPlaceholder),closeTag="</"+$(e).text().trim().replace(/<(.*?)\s.*?\>/gi,"$1")+">",newTag=$(e).text();var g=a.text().replace(d,newTag);a.text(g),a.html(a.html().replace(this.cursorPlaceholder,f)),restoreSelection(),a.html(a.html().replace(this.cursorPlaceholder,""))},markTagMismatch:function(a){"undefined"!=typeof a.tag_mismatch.source&&$.each(a.tag_mismatch.source,function(b){$("#segment-"+a.id_segment+" .source span.locked:not(.temp)").filter(function(){return $(this).text()===a.tag_mismatch.source[b]}).last().addClass("temp")}),"undefined"!=typeof a.tag_mismatch.target&&$.each(a.tag_mismatch.target,function(b){$("#segment-"+a.id_segment+" .editarea span.locked:not(.temp)").filter(function(){return $(this).text()===a.tag_mismatch.target[b]}).last().addClass("temp")}),$("#segment-"+a.id_segment+" span.locked.mismatch").addClass("mismatch-old").removeClass("mismatch"),$("#segment-"+a.id_segment+" span.locked.temp").addClass("mismatch").removeClass("temp"),$("#segment-"+a.id_segment+" span.locked.mismatch-old").removeClass("mismatch-old")},checkAutocompleteTags:function(){if(added=this.getPartialTagAutocomplete(),$(".tag-autocomplete li.hidden").removeClass("hidden"),$(".tag-autocomplete li").each(function(){var a=$(this).text();a.substring(0,added.length)===added?$(this).removeClass("hidden"):$(this).addClass("hidden")}),$(".tag-autocomplete li:not(.hidden)").length)$(".tag-autocomplete li.current").removeClass("current"),$(".tag-autocomplete li:not(.hidden)").first().addClass("current"),$(".tag-autocomplete").removeClass("empty"),UI.preCloseTagAutocomplete=!1;else{if($(".tag-autocomplete").addClass("empty"),UI.preCloseTagAutocomplete)return UI.closeTagAutocompletePanel(),!1;UI.preCloseTagAutocomplete=!0}},closeTagAutocompletePanel:function(){$(".tag-autocomplete, .tag-autocomplete-endcursor").remove(),UI.preCloseTagAutocomplete=!1},getPartialTagAutocomplete:function(){var a=UI.editarea.html().match(/&lt;(?:[a-z]*(?:&nbsp;)*["\w\s\/=]*)?<span class="tag-autocomplete-endcursor">/gi);return a=null===a?"":htmlDecode(a[0].replace(/<span class="tag-autocomplete-endcursor"\>/gi,"")).replace(/\xA0/gi," ")},openTagAutocompletePanel:function(){if(!UI.sourceTags.length)return!1;$(".tag-autocomplete-marker").remove();var a=document.createElement("span");a.setAttribute("class","tag-autocomplete-marker"),insertNodeAtCursor(a);var b=document.createElement("span");b.setAttribute("class","tag-autocomplete-endcursor"),insertNodeAtCursor(b);var c=$(".tag-autocomplete-marker").offset();$(".tag-autocomplete-marker").remove(),UI.body.append('<div class="tag-autocomplete"><ul></ul></div>'),$.each(UI.sourceTags,function(a){$(".tag-autocomplete ul").append("<li"+(0===a?' class="current"':"")+">"+this+"</li>")}),$(".tag-autocomplete").css("top",c.top+20),$(".tag-autocomplete").css("left",c.left),this.checkAutocompleteTags()},jumpTag:function(a){a=a||0,setTimeout(function(){saveSelection(),parentTag=$("span.locked",UI.editarea).has(" .rangySelectionBoundary"),isInsideTag=$("span.locked .rangySelectionBoundary",UI.editarea).length,restoreSelection(),isInsideTag&&setCursorPosition(parentTag[0],a)},50)}}),$.extend(UI,{getConcordance:function(a,b){$(".cc-search",UI.currentSegment).addClass("loading"),$(".sub-editor.concordances .overflow .results",this.currentSegment).empty(),a=view2rawxliff(a),APP.doRequest({data:{action:"getContribution",is_concordance:1,from_target:b,id_segment:UI.currentSegmentId,text:a,id_job:config.job_id,num_results:UI.numMatchesResults,id_translator:config.id_translator,password:config.password},success:function(a){UI.renderConcordances(a,b)}})},openConcordance:function(){this.closeContextMenu(),$(".editor .submenu .tab-switcher-cc a").click(),$(".editor .cc-search .input").text(""),$(".editor .concordances .results").empty();var a=$(this.currentSearchInTarget?".editor .cc-search .search-target":".editor .cc-search .search-source");$(a).text(this.currentSelectedText),this.getConcordance(this.currentSelectedText,this.currentSearchInTarget)},preOpenConcordance:function(){var a=window.getSelection();if("Range"==a.type){var b=$(a.baseNode.parentElement).hasClass("source"),c=a.toString().trim();c.length&&(this.currentSelectedText=c,this.currentSearchInTarget=b?0:1,this.openConcordance())}},renderConcordances:function(a,b){segment=this.currentSegment,segment_id=this.currentSegmentId,$(".sub-editor.concordances .overflow .results",segment).empty(),$(".sub-editor.concordances .overflow .message",segment).remove(),a.data.matches.length?$.each(a.data.matches,function(a){if(""!==this.segment&&""!==this.translation){var c="0"==this.id?!0:!1;cb=this.created_by,cl_suggestion=UI.getPercentuageClass(this.match);var d=b?this.translation:this.segment;d=d.replace(/\#\{/gi,"<mark>"),d=d.replace(/\}\#/gi,"</mark>");var e=b?this.segment:this.translation;e=e.replace(/\#\{/gi,"<mark>"),e=e.replace(/\}\#/gi,"</mark>"),$(".sub-editor.concordances .overflow .results",segment).append('<ul class="graysmall" data-item="'+(a+1)+'" data-id="'+this.id+'"><li class="sugg-source">'+(c?"":' <a id="'+segment_id+"-tm-"+this.id+'-delete" href="#" class="trash" title="delete this row"></a>')+'<span id="'+segment_id+"-tm-"+this.id+'-source" class="suggestion_source">'+d+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span id="'+segment_id+"-tm-"+this.id+'-translation" class="translation">'+e+'</span></li><ul class="graysmall-details"><!-- li class="percent '+cl_suggestion+'">'+this.match+"</li --><li>"+this.last_update_date+'</li><li class="graydesc">Source: <span class="bold">'+cb+"</span></li></ul></ul>")}}):(console.log("no matches"),$(".sub-editor.concordances .overflow",segment).append('<ul class="graysmall message"><li>Sorry. Can\'t help you this time. Check the language pair if you feel this is weird.</li></ul>')),$(".cc-search",this.currentSegment).removeClass("loading"),this.setDeleteSuggestion(segment)},markTagsInSearch:function(a){if(!this.taglockEnabled)return!1;var b="undefined"==typeof a?$(".editor .cc-search .input"):a;b.each(function(){})}}),$.extend(UI,{deleteGlossaryItem:function(a){APP.doRequest({data:{action:"glossary",exec:"delete",segment:a.find(".suggestion_source").text(),translation:a.find(".translation").text(),id_job:config.job_id,password:config.password},success:function(){}}),dad=$(a).prevAll(".glossary-item").first(),$(a).remove(),($(dad).next().hasClass("glossary-item")||!$(dad).next().length)&&($(dad).remove(),numLabel=$(".tab-switcher-gl a .number",UI.currentSegment),num=parseInt(numLabel.attr("data-num"))-1,num?$(numLabel).text("("+num+")").attr("data-num",num):$(numLabel).text("").attr("data-num",0))},getGlossary:function(a,b,c){return"undefined"!=typeof c?b&&(n=$(0===c?a:1==c?"#segment-"+this.nextSegmentId:"#segment-"+this.nextUntranslatedSegmentId)):n=a,$(n).hasClass("glossary-loaded")&&b?!1:($(n).addClass("glossary-loaded"),$(".gl-search",n).addClass("loading"),$(".sub-editor.glossary .overflow .results",n).empty(),$(".sub-editor.glossary .overflow .graysmall.message",n).empty(),txt=b?$(".text .source",n).attr("data-original"):view2rawxliff($(".gl-search .search-source",n).text()),void APP.doRequest({data:{action:"glossary",exec:"get",segment:txt,automatic:b,translation:null,id_job:config.job_id,password:config.password},context:[n,c],success:function(a){"undefined"!=typeof a.errors&&-1==a.errors[0].code&&(UI.noGlossary=!0),UI.processLoadedGlossary(a,this)},complete:function(){$(".gl-search",UI.currentSegment).removeClass("loading")}}))},processLoadedGlossary:function(a,b){segment=b[0],next=b[1],(1==next||2==next)&&($(".footer .submenu",segment).length||setTimeout(function(){UI.processLoadedGlossary(a,b)},200)),numMatches=Object.size(a.data.matches),numMatches?(UI.renderGlossary(a,segment),$(".tab-switcher-gl a .number",segment).text("("+numMatches+")").attr("data-num",numMatches)):$(".tab-switcher-gl a .number",segment).text("").attr("data-num",0)},renderGlossary:function(a,b){segment=b,segment_id=segment.attr("id"),$(".sub-editor.glossary .overflow .results",segment).empty(),$(".sub-editor.glossary .overflow .message",segment).remove(),numRes=0,Object.size(a.data.matches)?(console.log("ci sono match"),$.each(a.data.matches,function(a){numRes++,$(".sub-editor.glossary .overflow .results",segment).append('<div class="glossary-item"><span>'+a+"</span></div>"),$.each(this,function(a){if(""!==this.segment&&""!==this.translation){var b="0"==this.id?!0:!1;cb=this.created_by,this.comment="undefined"==typeof this.target_note?"":this.target_note,cl_suggestion=UI.getPercentuageClass(this.match);var c=this.segment;c=c.replace(/\#\{/gi,"<mark>"),c=c.replace(/\}\#/gi,"</mark>");var d=this.translation;d=d.replace(/\#\{/gi,"<mark>"),d=d.replace(/\}\#/gi,"</mark>"),$(".sub-editor.glossary .overflow .results",segment).append('<ul class="graysmall" data-item="'+(a+1)+'" data-id="'+this.id+'"><li class="sugg-source">'+(b?"":' <a id="'+segment_id+"-tm-"+this.id+'-delete" href="#" class="trash" title="delete this row"></a>')+'<span id="'+segment_id+"-tm-"+this.id+'-source" class="suggestion_source">'+c+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span id="'+segment_id+"-tm-"+this.id+'-translation" class="translation">'+d+'</span></li><li class="details">'+(""===this.comment?"":'<div class="comment">'+this.comment+"</div>")+'<ul class="graysmall-details"><li>'+this.last_update_date+'</li><li class="graydesc">Source: <span class="bold">'+cb+"</span></li></ul></li></ul>")}})})):(console.log("no matches"),$(".sub-editor.glossary .overflow",segment).append('<ul class="graysmall message"><li>Sorry. Can\'t help you this time.</li></ul>'))},setGlossaryItem:function(){$(".gl-search",UI.currentSegment).addClass("setting"),APP.doRequest({data:{action:"glossary",exec:"set",segment:UI.currentSegment.find(".gl-search .search-source").text(),translation:UI.currentSegment.find(".gl-search .search-target").text(),comment:UI.currentSegment.find(".gl-search .gl-comment").text(),id_job:config.job_id,password:config.password},context:[UI.currentSegment,next],success:function(a){a.data.created_tm_key?(UI.footerMessage("A Private TM Key has been created for this job",this[0]),UI.noGlossary=!1):UI.footerMessage("A glossary item has been added",this[0]),UI.processLoadedGlossary(a,this)
},complete:function(){$(".gl-search",UI.currentSegment).removeClass("setting")}})}}),$.extend(UI,{applySearch:function(a){this.body.hasClass("searchActive")&&this.markSearchResults({singleSegment:a,where:"no"})},resetSearch:function(){this.body.removeClass("searchActive"),this.clearSearchMarkers(),this.setFindFunction("find"),$("#exec-find").removeAttr("disabled"),this.enableTagMark()},execFind:function(){if(this.searchResultsSegments=!1,$(".search-display").removeClass("displaying"),$("section.currSearchSegment").removeClass("currSearchSegment"),""!==$("#search-source").val()?this.searchParams.source=$("#search-source").val():delete this.searchParams.source,""!==$("#search-target").val()?(this.searchParams.target=$("#search-target").val(),$("#enable-replace").is(":checked")&&$("#replace-target, #exec-replace, #exec-replaceall").removeAttr("disabled")):(delete this.searchParams.target,$("#replace-target, #exec-replace, #exec-replaceall").attr("disabled","disabled")),""!==$("#select-status").val()?(this.searchParams.status=$("#select-status").val(),this.body.attr("data-filter-status",$("#select-status").val())):delete this.searchParams.status,""!==$("#replace-target").val()?this.searchParams.replace=$("#replace-target").val():delete this.searchParams.replace,this.searchParams["match-case"]=$("#match-case").is(":checked"),this.searchParams["exact-match"]=$("#exact-match").is(":checked"),this.searchParams.search=1,"undefined"==typeof this.searchParams.source&&"undefined"==typeof this.searchParams.target&&"all"==this.searchParams.status)return APP.alert({msg:"You must specify at least one between source and target<br>or choose a status"}),!1;this.disableTagMark();var a=this.searchParams;this.searchMode="undefined"==typeof a.source&&"undefined"==typeof a.target?"onlyStatus":"undefined"!=typeof a.source&&"undefined"!=typeof a.target?"source&target":"normal","onlyStatus"==this.searchMode||"source&target"==this.searchMode;var b=a.source?a.source:"",c=a.target?a.target:"",d=a.replace?a.replace:"";this.markSearchResults(),this.gotoSearchResultAfter({el:"segment-"+this.currentSegmentId}),this.setFindFunction("next"),this.body.addClass("searchActive");var e=new Date;APP.doRequest({data:{action:"getSearch","function":"find",job:config.job_id,token:e.getTime(),password:config.password,source:b,target:c,status:this.searchParams.status,matchcase:this.searchParams["match-case"],exactmatch:this.searchParams["exact-match"],replace:d},success:function(a){UI.execFind_success(a)}})},execFind_success:function(a){this.numSearchResultsItem=a.total,this.searchResultsSegments=a.segments,this.numSearchResultsSegments=a.segments?a.segments.length:0,this.updateSearchDisplay(),this.pendingRender&&(this.pendingRender.detectSegmentToScroll&&(this.pendingRender.segmentToScroll=this.nextUnloadedResultSegment()),$("#outer").empty(),this.render(this.pendingRender),this.pendingRender=!1)},execReplaceAll:function(){if($(".search-display .numbers").text("No segments found"),$(".editarea mark.searchMarker").remove(),this.applySearch(),""===$("#search-target").val())return APP.alert({msg:"You must specify the Target value to replace."}),delete this.searchParams.target,!1;if(this.searchParams.target=$("#search-target").val(),""===$("#replace-target").val())return APP.alert({msg:"You must specify the replacement value."}),delete this.searchParams.replace,!1;this.searchParams.replace=$("#replace-target").val(),""!==$("#select-status").val()?(this.searchParams.status=$("#select-status").val(),this.body.attr("data-filter-status",$("#select-status").val())):delete this.searchParams.status,this.searchParams["match-case"]=$("#match-case").is(":checked"),this.searchParams["exact-match"]=$("#exact-match").is(":checked");var a=this.searchParams,b=a.source?a.source:"",c=a.target?a.target:"",d=a.replace?a.replace:"",e=new Date;APP.doRequest({data:{action:"getSearch","function":"replaceAll",job:config.job_id,token:e.getTime(),password:config.password,source:b,target:c,status:a.status,matchcase:a["match-case"],exactmatch:a["exact-match"],replace:d},success:function(a){return a.error.length?(APP.alert({msg:a.error[0].message}),!1):($("#outer").empty(),void UI.render({firstLoad:!1}))}})},checkSearchStrings:function(){s=this.searchParams.source,s.match(/[<\>]/gi)?this.disableTagMark():this.enableTagMark()},updateSearchDisplay:function(){"onlyStatus"==this.searchMode?(res=this.numSearchResultsSegments?this.numSearchResultsSegments:0,resNumString=1==res?"":"s",numbers=res?'Found <span class="segments">...</span> segment'+resNumString:"No segments found",$(".search-display .numbers").html(numbers)):"source&target"==this.searchMode?(res=this.numSearchResultsSegments?this.numSearchResultsSegments:0,resNumString=1==res?"":"s",numbers=res?'Found <span class="segments">...</span> segment'+resNumString:"No segments found",$(".search-display .numbers").html(numbers)):(res=this.numSearchResultsItem?this.numSearchResultsItem:0,resNumString=1==res?"":"s",numbers=res?'Found <span class="results">...</span> result'+resNumString+' in <span class="segments">...</span> segment'+resNumString:"No segments found",$(".search-display .numbers").html(numbers),$(".search-display .results").text(res)),$(".search-display .segments").text(this.numSearchResultsSegments),query="",this.searchParams["exact-match"]&&(query+=" exactly"),this.searchParams.source&&(query+=' <span class="param">'+this.searchParams.source+"</span> in source"),this.searchParams.target&&(query+=' <span class="param">'+this.searchParams.target+"</span> in target"),this.searchParams.status&&(query+=(this.searchParams.source||this.searchParams.target?" and":"")+' status <span class="param">'+this.searchParams.status+"</span>"),query+=" ("+(this.searchParams["match-case"]?"case sensitive":"case insensitive")+")",$(".search-display .query").html(query),$(".search-display").addClass("displaying"),"normal"==this.searchMode&&this.numSearchResultsItem<2&&$("#exec-find[data-func=next]").attr("disabled","disabled"),"source&target"==this.searchMode&&this.numSearchResultsSegments<2&&$("#exec-find[data-func=next]").attr("disabled","disabled"),this.updateSearchItemsCount(),this.someSegmentToSave()?this.addWarningToSearchDisplay():this.removeWarningFromSearchDisplay()},addWarningToSearchDisplay:function(){$(".search-display .found .warning").length||$(".search-display .found").append('<span class="warning"></span>'),$(".search-display .found .warning").text(" (maybe some results in segments modified but not saved)")},removeWarningFromSearchDisplay:function(){$(".search-display .found .warning").remove()},updateSearchDisplayCount:function(a){numRes=$(".search-display .numbers .results"),numRes.text(parseInt(numRes.text())-1),$(".editarea mark.searchMarker",a).length-1===0&&(numSeg=$(".search-display .numbers .segments"),numSeg.text(parseInt(numSeg.text())-1)),this.updateSearchItemsCount()},updateSearchItemsCount:function(){c=parseInt($(".search-display .numbers .results").text()),c>0&&$("#filterSwitch .numbererror").text(c).attr("title",$(".search-display .found").text())},execNext:function(){this.gotoNextResultItem(!1)},markSearchResults:function(a){a=a||{},where=a.where,seg=a.seg,singleSegment=a.singleSegment||!1,"undefined"==typeof where&&this.clearSearchMarkers();var b=this.searchParams,c=("undefined"!=typeof b.target,b["match-case"]?"contains":"containsNC"),d=b["match-case"]?"":"i";if(openTagReg=new RegExp(UI.openTagPlaceholder,"g"),closeTagReg=new RegExp(UI.closeTagPlaceholder,"g"),"onlyStatus"==this.searchMode);else if("source&target"==this.searchMode){console.log("source & target"),status="all"==b.status?"":".status-"+b.status,q=singleSegment?"#"+$(singleSegment).attr("id"):"section"+status+":not(.status-new)";var e=new RegExp("("+htmlEncode(b.source)+")","g"+d),f=new RegExp("("+htmlEncode(b.target)+")","g"+d);txtSrc=b.source,txtTrg=b.target,srcHasTags=null!==txtSrc.match(/<.*?\>/gi)?!0:!1,trgHasTags=null!==txtTrg.match(/<.*?\>/gi)?!0:!1,"undefined"==typeof where?(UI.doMarkSearchResults(srcHasTags,$(q+" .source:"+c+"('"+txtSrc+"')"),e,q,txtSrc,d),UI.doMarkSearchResults(trgHasTags,$(q+" .editarea:"+c+"('"+txtTrg+"')"),f,q,txtTrg,d),$("section").has(".source mark.searchPreMarker").has(".editarea mark.searchPreMarker").find("mark.searchPreMarker").addClass("searchMarker").removeClass("searchPreMarker"),$("mark.searchPreMarker:not(.searchMarker)").each(function(){var a=$(this).text();$(this).replaceWith(a)})):(sid=$(seg).attr("id"),$("section").each("before"==where?function(){$(this).attr("id")<sid&&$(this).addClass("justAdded")}:function(){$(this).attr("id")>sid&&$(this).addClass("justAdded")}),UI.execSearchResultsMarking(UI.filterExactMatch($(q+".justAdded:not(.status-new) .source:"+c+"('"+txtSrc+"')"),txtSrc),e,!1),UI.execSearchResultsMarking(UI.filterExactMatch($(q+".justAdded:not(.status-new) .editarea:"+c+"('"+txtTrg+"')"),txtTrg),f,!1),$("section").has(".source mark.searchPreMarker").has(".editarea mark.searchPreMarker").find("mark.searchPreMarker").addClass("searchMarker"),$("mark.searchPreMarker").removeClass("searchPreMarker"),$("section.justAdded").removeClass("justAdded"))}else{status="all"==b.status?"":".status-"+b.status;var g="undefined"!=typeof b.source?b.source:"undefined"!=typeof b.target?b.target:"";singleSegment?(what="undefined"!=typeof b.source?" .source":"undefined"!=typeof b.target?" .editarea":"",q="#"+$(singleSegment).attr("id")+what):(what="undefined"!=typeof b.source?" .source":"undefined"!=typeof b.target?":not(.status-new) .editarea":"",q="section"+status+what),hasTags=null!==g.match(/<.*?\>/gi)?!0:!1;var h=g.replace("<",UI.openTagPlaceholder).replace(">",UI.closeTagPlaceholder),i=new RegExp("("+htmlEncode(h)+")","g"+d);"undefined"==typeof where||"no"==where?UI.doMarkSearchResults(hasTags,$(q+":"+c+"('"+g+"')"),i,q,g,d):(sid=$(seg).attr("id"),$("section").each("before"==where?function(){$(this).attr("id")<sid&&$(this).addClass("justAdded")}:function(){$(this).attr("id")>sid&&$(this).addClass("justAdded")}),UI.doMarkSearchResults(hasTags,$("section"+status+".justAdded"+what+":"+c+"('"+g+"')"),i,q,g,d),$("section.justAdded").removeClass("justAdded"))}singleSegment||(UI.unmarkNumItemsInSegments(),UI.markNumItemsInSegments())},doMarkSearchResults:function(a,b,c,d,e,f){a?(inputReg=new RegExp(e,"g"+f),this.execSearchResultsMarking($(d),c,inputReg)):this.execSearchResultsMarking(UI.filterExactMatch(b,e),c,!1)},execSearchResultsMarking:function(a,b,c){searchMarker="source&target"==UI.searchMode?"searchPreMarker":"searchMarker",$(a).each(function(){if(!c||null!==$(this).text().match(c)){var a=$(this).html().replace(/&lt;/g,UI.openTagPlaceholder).replace(/&gt;/g,UI.closeTagPlaceholder).replace(b,'<mark class="'+searchMarker+'">$1</mark>').replace(openTagReg,"&lt;").replace(closeTagReg,"&gt;").replace(/(<span(.*)?>).*?<mark.*?>(.*?)<\/mark>.*?(<\/span>)/gi,"$1$3$4");$(this).html(a)}})},filterExactMatch:function(a,b){return this.searchParams["exact-match"]?a.filter(function(){return UI.searchParams["match-case"]?$(this).text()==b:$(this).text().toUpperCase()==b.toUpperCase()}):a},clearSearchFields:function(){$(".searchbox form")[0].reset()},clearSearchMarkers:function(){$("mark.searchMarker").each(function(){$(this).replaceWith($(this).text())}),$("section.currSearchResultSegment").removeClass("currSearchResultSegment")},gotoNextResultItem:function(a){var b=this.searchParams;if("onlyStatus"==this.searchMode){console.log("only status");var c="all"==b.status?"":".status-"+b.status;el=$("section.currSearchSegment"),"all"==b.status?this.scrollSegment($(el).next()):el.nextAll(c).length?(nextToGo=el.nextAll(c).first(),$(el).removeClass("currSearchSegment"),nextToGo.addClass("currSearchSegment"),this.scrollSegment(nextToGo)):(this.pendingRender={firstLoad:!1,applySearch:!0,detectSegmentToScroll:!0,segmentToScroll:this.nextUnloadedResultSegment()},$("#outer").empty(),this.render(this.pendingRender),this.pendingRender=!1)}else"source&target"==this.searchMode?(m=$(".editarea mark.currSearchItem"),$(m).nextAll("mark.searchMarker").length?(console.log("altri item nel segmento"),$(m).removeClass("currSearchItem"),$(m).nextAll("mark.searchMarker").first().addClass("currSearchItem"),a&&$(m).replaceWith($(m).text()),UI.goingToNext=!1):(console.log("m.length: "+m.length),seg=m.length?$(m).parents("section"):$("mark.searchMarker").first().parents("section"),seg.length?(skipCurrent=$(seg).has("mark.currSearchItem").length,this.gotoSearchResultAfter({el:"segment-"+$(seg).attr("id").split("-")[1],skipCurrent:skipCurrent,unmark:a})):setTimeout(function(){UI.gotoNextResultItem(!1)},500))):(m=$("mark.currSearchItem"),$(m).nextAll("mark.searchMarker").length?(console.log("altri item nel segmento"),$(m).removeClass("currSearchItem"),$(m).nextAll("mark.searchMarker").first().addClass("currSearchItem"),a&&$(m).replaceWith($(m).text()),UI.goingToNext=!1):(seg=m.length?$(m).parents("section"):$("mark.searchMarker").first().parents("section"),seg.length?(skipCurrent=$(seg).has("mark.currSearchItem").length,this.gotoSearchResultAfter({el:"segment-"+$(seg).attr("id").split("-")[1],skipCurrent:skipCurrent,unmark:a})):setTimeout(function(){UI.gotoNextResultItem(!1)},500)))},gotoSearchResultAfter:function(a){el=a.el,skipCurrent=a.skipCurrent||!1,unmark=a.unmark||!1;var b=this.searchParams;if("onlyStatus"==this.searchMode){var c="all"==b.status?"":".status-"+b.status;"all"==b.status?this.scrollSegment($("#"+el).next()):$("#"+el).nextAll(c).length?(nextToGo=$("#"+el).nextAll(c).first(),nextToGo.addClass("currSearchSegment"),this.scrollSegment(nextToGo)):this.searchResultsSegments?(seg2scroll=this.nextUnloadedResultSegment(),$("#outer").empty(),this.render({firstLoad:!1,applySearch:!0,segmentToScroll:seg2scroll})):this.pendingRender={firstLoad:!1,applySearch:!0,detectSegmentToScroll:!0}}else{var d="source&target"==this.searchMode?" .editarea":"";seg=$("section"+d).has("mark.searchMarker"),ss="source&target"==this.searchMode?el+"-editarea":el,found=!1,$.each(seg,function(){if($(this).attr("id")>=ss&&($(this).attr("id")!=ss||!skipCurrent)){found=!0,$("html,body").animate({scrollTop:$(this).offset().top-200},500),setTimeout(function(){UI.goingToNext=!1},500);var a=$("mark.currSearchItem");return $(a).removeClass("currSearchItem"),$(this).find("mark.searchMarker").first().addClass("currSearchItem"),unmark&&$(a).replaceWith($(a).text()),!1}}),found||(this.searchResultsSegments?(seg2scroll=this.nextUnloadedResultSegment(),$("#outer").empty(),this.render({firstLoad:!1,applySearch:!0,segmentToScroll:seg2scroll})):this.pendingRender={firstLoad:!1,applySearch:!0,detectSegmentToScroll:!0})}},checkSearchChanges:function(){changes=!1;var a=this.searchParams;return a.source!=$("#search-source").val()&&("undefined"!=typeof a.source||""!==$("#search-source").val())&&(changes=!0),a.target!=$("#search-target").val()&&("undefined"!=typeof a.target||""!==$("#search-target").val())&&(changes=!0),a.status!=$("#select-status").val()&&"undefined"!=typeof a.status&&(changes=!0),a["match-case"]!=$("#match-case").is(":checked")&&(changes=!0),a["exact-match"]!=$("#exact-match").is(":checked")&&(changes=!0),changes},setFindFunction:function(a){var b=$("#exec-find");"next"==a?b.attr("data-func","next").attr("value","Next"):b.attr("data-func","find").attr("value","Find"),b.removeAttr("disabled")},unmarkNumItemsInSegments:function(){$("section[data-searchItems]").removeAttr("data-searchItems")},markNumItemsInSegments:function(){$("section").has("mark.searchMarker").each(function(){$(this).attr("data-searchItems",$("mark.searchMarker",this).length)})},toggleSearch:function(a){this.searchEnabled&&(a.preventDefault(),$("body").hasClass("filterOpen")?$("body").removeClass("filterOpen"):($("body").addClass("filterOpen"),$("#search-source").focus()))}});var LTPLACEHOLDER="##LESSTHAN##",GTPLACEHOLDER="##GREATERTHAN##",re_lt=new RegExp(LTPLACEHOLDER,"g"),re_gt=new RegExp(GTPLACEHOLDER,"g");$.fn.isOnScreen=function(){var a=$(window),b={top:a.scrollTop(),left:a.scrollLeft()};b.right=b.left+a.width(),b.bottom=b.top+a.height();var c=this.offset();return c.right=c.left+this.outerWidth(),c.bottom=c.top+this.outerHeight(),!(b.right<c.left||b.left>c.right||b.bottom<c.top||b.top>c.bottom)},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c};